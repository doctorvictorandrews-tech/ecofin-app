<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de An√°lise - EcoFin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary-dark: #1a1a2e;
            --secondary-dark: #16213e;
            --accent-gold: #daa520;
            --accent-brown: #8b4513;
            --accent-green: #2ecc71;
            --text-light: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-dark) 100%);
            color: var(--text-light);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* HEADER */
        .header {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid var(--accent-gold);
        }

        .header h1 {
            font-size: 2.5rem;
            color: var(--accent-gold);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header p {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .btn-voltar {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .btn-voltar:hover {
            background: var(--accent-gold);
            color: var(--primary-dark);
            transform: translateX(-5px);
        }

        /* LOADING */
        .loading {
            text-align: center;
            padding: 60px;
        }

        .loading i {
            font-size: 4rem;
            color: var(--accent-gold);
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* ESTRAT√âGIA OTIMIZADA */
        .estrategia-otimizada {
            background: linear-gradient(135deg, rgba(218, 165, 32, 0.15), rgba(139, 69, 19, 0.15));
            border: 3px solid var(--accent-gold);
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 30px;
        }

        .estrategia-otimizada h2 {
            font-size: 2rem;
            color: var(--accent-gold);
            margin-bottom: 20px;
            text-align: center;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .metric-card {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-gold);
            box-shadow: 0 10px 30px rgba(218, 165, 32, 0.3);
        }

        .metric-card .icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .metric-card .label {
            display: block;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-card .value {
            display: block;
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--accent-green);
        }

        .viabilidade-alta { color: var(--accent-green) !important; }
        .viabilidade-m√©dia { color: #f39c12 !important; }
        .viabilidade-baixa { color: #e74c3c !important; }

        /* VIABILIDADE COM EXPLICA√á√ÉO */
        .viabilidade-card {
            position: relative;
        }

        .viabilidade-explicacao {
            margin-top: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            gap: 10px;
            align-items: flex-start;
            text-align: left;
        }

        .viabilidade-explicacao i {
            color: var(--accent-gold);
            margin-top: 2px;
            font-size: 1rem;
        }

        /* DADOS DO FINANCIAMENTO */
        .dados-financiamento {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .dados-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .dado-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .dado-item strong {
            color: var(--accent-gold);
        }

        /* ESTRAT√âGIA DETALHADA - RECEITA DE BOLO */
        .strategy-detailed {
            background: linear-gradient(135deg, rgba(218, 165, 32, 0.1), rgba(139, 69, 19, 0.1));
            border: 2px solid var(--accent-gold);
            border-radius: 16px;
            padding: 30px;
            margin: 30px 0;
        }

        .strategy-detailed h2 {
            font-size: 1.8rem;
            color: var(--accent-gold);
            margin-bottom: 10px;
        }

        .strategy-detailed .subtitle {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 30px;
        }

        .passo-container {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 25px;
            border-left: 4px solid var(--accent-gold);
        }

        .passo-numero {
            flex-shrink: 0;
            width: 50px;
            height: 50px;
            background: var(--accent-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-dark);
        }

        .passo-conteudo {
            flex: 1;
        }

        .passo-conteudo h3 {
            font-size: 1.3rem;
            color: var(--accent-gold);
            margin-bottom: 15px;
        }

        .passo-detalhes {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .detalhe-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
        }

        .detalhe-item strong {
            color: var(--accent-gold);
            display: block;
            margin-bottom: 8px;
        }

        .lista-acoes {
            margin: 10px 0 0 20px;
            color: rgba(255, 255, 255, 0.9);
        }

        .lista-acoes li {
            margin: 8px 0;
            line-height: 1.6;
        }

        .destaque-economia {
            background: rgba(218, 165, 32, 0.15);
            border-left: 3px solid var(--accent-gold);
        }

        .alerta-info,
        .alerta-importante {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .alerta-info {
            background: rgba(52, 152, 219, 0.2);
            border-left: 3px solid #3498db;
        }

        .alerta-importante {
            background: rgba(231, 76, 60, 0.2);
            border-left: 3px solid #e74c3c;
        }

        .timeline-marcos {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }

        .marco {
            display: flex;
            gap: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--accent-green);
        }

        .marco-tempo {
            flex-shrink: 0;
            text-align: center;
            min-width: 80px;
        }

        .marco-tempo i {
            font-size: 2rem;
            color: var(--accent-green);
            display: block;
            margin-bottom: 8px;
        }

        .marco-tempo span {
            font-weight: bold;
            color: var(--accent-gold);
        }

        .marco-conquista strong {
            color: var(--accent-gold);
            font-size: 1.1rem;
            display: block;
            margin-bottom: 8px;
        }

        .alertas-importantes {
            margin-top: 30px;
            padding: 25px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
        }

        .alertas-importantes h3 {
            color: var(--accent-gold);
            margin-bottom: 20px;
        }

        .alerta-card {
            display: flex;
            gap: 15px;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .alerta-card i {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .alerta-warning {
            background: rgba(241, 196, 15, 0.15);
            border-left: 3px solid #f1c40f;
        }

        .alerta-warning i {
            color: #f1c40f;
        }

        .alerta-success {
            background: rgba(46, 204, 113, 0.15);
            border-left: 3px solid #2ecc71;
        }

        .alerta-success i {
            color: #2ecc71;
        }

        /* GR√ÅFICOS COMPARATIVOS */
        .chart-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 25px;
            margin: 30px 0;
        }

        .chart-container h3 {
            color: var(--accent-gold);
            margin-bottom: 20px;
        }

        .comparison-cards {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            margin: 20px 0;
            align-items: center;
        }

        .comparison-card {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid;
        }

        .comparison-card.sem-ecofin {
            border-color: #e74c3c;
        }

        .comparison-card.com-ecofin {
            border-color: var(--accent-green);
        }

        .comparison-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .comparison-header i {
            font-size: 1.5rem;
        }

        .sem-ecofin .comparison-header i {
            color: #e74c3c;
        }

        .com-ecofin .comparison-header i {
            color: var(--accent-green);
        }

        .comparison-header h4 {
            font-size: 1.2rem;
            margin: 0;
        }

        .comparison-body .metric {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .comparison-body .metric .label {
            color: rgba(255, 255, 255, 0.7);
        }

        .comparison-body .metric .value {
            font-weight: bold;
            color: #fff;
        }

        .comparison-arrow {
            text-align: center;
            color: var(--accent-gold);
        }

        .comparison-arrow i {
            font-size: 2rem;
            display: block;
            margin-bottom: 8px;
        }

        .comparison-arrow span {
            font-size: 0.9rem;
            display: block;
            line-height: 1.3;
        }

        .economia-destaque {
            display: flex;
            align-items: center;
            gap: 20px;
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.2), rgba(39, 174, 96, 0.2));
            border: 2px solid var(--accent-green);
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
        }

        .economia-destaque i {
            font-size: 3rem;
            color: var(--accent-gold);
        }

        .economia-destaque strong {
            display: block;
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
        }

        .valor-economia {
            display: block;
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-green);
            margin-bottom: 5px;
        }

        .percentual-economia {
            display: block;
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* CEN√ÅRIOS ALTERNATIVOS */
        .alternative-scenarios {
            margin: 40px 0;
        }

        .alternative-scenarios h2 {
            font-size: 1.8rem;
            color: var(--accent-gold);
            margin-bottom: 10px;
        }

        .alternative-scenarios .subtitle {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 30px;
        }

        .scenarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .scenario-card {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            position: relative;
            transition: all 0.3s ease;
        }

        .scenario-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-gold);
            box-shadow: 0 10px 30px rgba(218, 165, 32, 0.3);
        }

        .scenario-recommended {
            border-color: var(--accent-gold);
            background: linear-gradient(135deg, rgba(218, 165, 32, 0.1), rgba(139, 69, 19, 0.1));
        }

        .scenario-badge {
            position: absolute;
            top: -12px;
            right: 20px;
            background: var(--accent-gold);
            color: var(--primary-dark);
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .scenario-badge-blue {
            background: #3498db;
            color: #fff;
        }

        .scenario-badge-orange {
            background: #e67e22;
            color: #fff;
        }

        .scenario-header {
            margin: 20px 0;
        }

        .scenario-header h3 {
            font-size: 1.3rem;
            color: #fff;
            margin-bottom: 5px;
        }

        .scenario-type {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .scenario-params {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .param {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .param:last-child {
            margin-bottom: 0;
        }

        .param i {
            color: var(--accent-gold);
            font-size: 1.2rem;
            margin-top: 2px;
        }

        .param strong {
            display: block;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            margin-bottom: 3px;
        }

        .param span {
            display: block;
            color: #fff;
            font-size: 1rem;
        }

        .scenario-results {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .result-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .result-item .label {
            display: block;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .result-item .value {
            display: block;
            color: #fff;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .highlight-green {
            color: var(--accent-green) !important;
        }

        .scenario-explanation {
            background: rgba(218, 165, 32, 0.1);
            border-left: 3px solid var(--accent-gold);
            padding: 15px;
            border-radius: 8px;
        }

        .scenario-explanation strong {
            display: block;
            color: var(--accent-gold);
            margin-bottom: 8px;
        }

        .scenario-explanation p {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
            margin: 0;
        }

        /* TABELA COMPARATIVA */
        .comparison-table-container {
            margin-top: 40px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 25px;
        }

        .comparison-table-container h3 {
            color: var(--accent-gold);
            margin-bottom: 20px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .comparison-table th {
            background: rgba(218, 165, 32, 0.2);
            color: var(--accent-gold);
            font-weight: bold;
        }

        .comparison-table td:first-child {
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .comparison-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* BOT√ïES */
        .btn-download {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: var(--accent-gold);
            color: var(--primary-dark);
            padding: 15px 30px;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .btn-download:hover {
            background: var(--accent-brown);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(218, 165, 32, 0.4);
        }

        /* RESPONSIVO */
        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .comparison-cards {
                grid-template-columns: 1fr;
            }

            .comparison-arrow {
                transform: rotate(90deg);
            }

            .scenarios-grid {
                grid-template-columns: 1fr;
            }

            .passo-container {
                flex-direction: column;
            }

            .comparison-table {
                font-size: 0.85rem;
            }

            .comparison-table th,
            .comparison-table td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/admin" class="btn-voltar">
            <i class="fas fa-arrow-left"></i>
            Voltar ao Painel
        </a>

        <div class="header">
            <h1>
                <i class="fas fa-chart-line"></i>
                Dashboard de An√°lise Estrat√©gica
            </h1>
            <p>An√°lise completa e estrat√©gia otimizada para seu financiamento</p>
        </div>

        <div id="loading" class="loading">
            <i class="fas fa-spinner"></i>
            <p>Carregando an√°lise...</p>
        </div>

        <div id="dashboard-content" style="display: none;">
            <!-- Conte√∫do ser√° inserido via JavaScript -->
        </div>
    </div>

    <script>
        const API_URL = 'https://ecofin-api-production.up.railway.app'; // Atualizar para URL do Railway
        
        // Fun√ß√µes auxiliares
        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(valor);
        }

        function getExplicacaoViabilidade(viabilidade, percentual) {
            const explicacoes = {
                'ALTA': `Compromete at√© 30% da sua capacidade extra mensal. Muito confort√°vel e sustent√°vel no longo prazo. Voc√™ mant√©m flexibilidade financeira para imprevistos.`,
                'M√âDIA': `Compromete entre 30-70% da capacidade. Requer disciplina financeira, mas √© vi√°vel para quem tem renda est√°vel e reserva de emerg√™ncia.`,
                'BAIXA': `Compromete mais de 70% da capacidade dispon√≠vel. Pode apertar o or√ßamento. Recomendamos apenas se voc√™ tiver reserva s√≥lida de emerg√™ncia e estabilidade financeira garantida.`
            };
            return explicacoes[viabilidade] || 'An√°lise de viabilidade baseada no comprometimento da renda dispon√≠vel.';
        }

        function getExplicacaoCenario(cenario, tipo) {
            const compromisso = cenario.compromisso_mensal_pct || 0;
            const roi = cenario.roi || 0;
            const economia = cenario.economia_total || 0;
            
            const explicacoes = {
                'equilibrio': `Esta √© a op√ß√£o ideal para quem quer economizar o m√°ximo mantendo um bom equil√≠brio financeiro. 
                               Usa ${compromisso.toFixed(0)}% da sua capacidade mensal, deixando espa√ßo 
                               para imprevistos e mantendo qualidade de vida. O ROI de ${roi.toFixed(2)}x significa 
                               que cada R$ 1 investido retorna R$ ${roi.toFixed(2)} em economia!`,
                
                'conservador': `Ideal se voc√™ prefere ter mais flexibilidade financeira ou ainda est√° construindo sua reserva 
                                de emerg√™ncia. Economiza um valor significativo (R$ ${formatarMoeda(economia)}) 
                                sem comprometer tanto do or√ßamento mensal. Perfeita para quem valoriza seguran√ßa financeira.`,
                
                'agressivo': `Para quem quer se livrar da d√≠vida o mais r√°pido poss√≠vel e tem uma situa√ß√£o financeira muito 
                              est√°vel. Economiza o m√°ximo poss√≠vel (R$ ${formatarMoeda(economia)}) e reduz 
                              drasticamente o prazo. Requer disciplina e reserva de emerg√™ncia s√≥lida.`
            };
            
            return explicacoes[tipo] || 'Estrat√©gia alternativa baseada no seu perfil financeiro.';
        }

        function calcularPMT(taxa, prazo, valor) {
            if (taxa === 0) return valor / prazo;
            const fator = Math.pow(1 + taxa, prazo);
            return valor * (taxa * fator) / (fator - 1);
        }

        async function carregarDashboard() {
            const urlParams = new URLSearchParams(window.location.search);
            const clienteId = urlParams.get('id');

            if (!clienteId) {
                alert('ID do cliente n√£o fornecido');
                window.location.href = '/admin';
                return;
            }

            try {
                // Buscar dados do lead
                const response = await fetch(`${API_URL}/lead/${clienteId}`);
                
                if (!response.ok) {
                    throw new Error('Cliente n√£o encontrado');
                }

                const dados = await response.json();
                
                // Renderizar dashboard
                renderizarDashboard(dados);
                
                // Ocultar loading
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';

            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
                alert('Erro ao carregar an√°lise: ' + error.message);
                window.location.href = '/admin';
            }
        }

        function renderizarDashboard(dados) {
            const container = document.getElementById('dashboard-content');
            
            const estrategia = dados.analise_otimizada?.melhor_geral || dados.analise_otimizada?.estrategia_otima;
            const cenarioOriginal = dados.analise_otimizada?.cenario_original || {};
            const cenariosAlternativos = dados.analise_otimizada?.top3_diversas || [];
            const dadosFinanciamento = dados.dados_financiamento || {};

            if (!estrategia) {
                container.innerHTML = '<p>Erro: Dados de an√°lise n√£o encontrados.</p>';
                return;
            }

            container.innerHTML = `
                <!-- ESTRAT√âGIA OTIMIZADA -->
                <div class="estrategia-otimizada">
                    <h2><i class="fas fa-trophy"></i> Estrat√©gia Otimizada</h2>
                    <p style="text-align: center; color: var(--text-muted); margin-bottom: 20px;">
                        An√°lise completa do seu financiamento e melhor estrat√©gia de amortiza√ß√£o identificada.
                    </p>

                    <div class="metrics-grid">
                        <div class="metric-card">
                            <span class="icon">üí∞</span>
                            <span class="label">ECONOMIA TOTAL</span>
                            <span class="value">R$ ${formatarMoeda(estrategia.economia_total)}</span>
                        </div>

                        <div class="metric-card">
                            <span class="icon">üìÖ</span>
                            <span class="label">REDU√á√ÉO DE PRAZO</span>
                            <span class="value">${estrategia.reducao_prazo} meses</span>
                        </div>

                        <div class="metric-card">
                            <span class="icon">üìà</span>
                            <span class="label">ROI DA ESTRAT√âGIA</span>
                            <span class="value">${estrategia.roi.toFixed(2)}x</span>
                        </div>

                        <div class="metric-card viabilidade-card">
                            <span class="icon">üìä</span>
                            <span class="label">VIABILIDADE</span>
                            <span class="value viabilidade-${estrategia.viabilidade.toLowerCase()}">${estrategia.viabilidade}</span>
                            <div class="viabilidade-explicacao">
                                <i class="fas fa-info-circle"></i>
                                <span>${estrategia.explicacao_viabilidade || getExplicacaoViabilidade(estrategia.viabilidade, estrategia.compromisso_mensal_pct)}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DADOS DO FINANCIAMENTO -->
                <div class="dados-financiamento">
                    <h3 style="color: var(--accent-gold); margin-bottom: 20px;">
                        <i class="fas fa-home"></i> Dados do Financiamento
                    </h3>
                    <div class="dados-grid">
                        <div class="dado-item">
                            <strong>Saldo Devedor:</strong>
                            <span>R$ ${formatarMoeda(dadosFinanciamento.saldo_devedor)}</span>
                        </div>
                        <div class="dado-item">
                            <strong>Taxa de Juros:</strong>
                            <span>${(dadosFinanciamento.taxa_anual * 100).toFixed(2)}% a.a.</span>
                        </div>
                        <div class="dado-item">
                            <strong>Prazo Original:</strong>
                            <span>${dadosFinanciamento.prazo_meses} meses (${(dadosFinanciamento.prazo_meses / 12).toFixed(1)} anos)</span>
                        </div>
                        <div class="dado-item">
                            <strong>Sistema:</strong>
                            <span>${dadosFinanciamento.sistema}</span>
                        </div>
                        <div class="dado-item">
                            <strong>FGTS Dispon√≠vel:</strong>
                            <span>R$ ${formatarMoeda(dados.valor_fgts || 0)}</span>
                        </div>
                        <div class="dado-item">
                            <strong>Capacidade Extra:</strong>
                            <span>R$ ${formatarMoeda(dados.capacidade_extra_mensal || 0)}/m√™s</span>
                        </div>
                    </div>
                </div>

                <!-- ESTRAT√âGIA DETALHADA (RECEITA DE BOLO) -->
                <div class="strategy-detailed">
                    <h2><i class="fas fa-clipboard-check"></i> Seu Plano de A√ß√£o - Passo a Passo</h2>
                    <p class="subtitle">
                        Siga esta receita de bolo para economizar <strong>R$ ${formatarMoeda(estrategia.economia_total)}</strong> no seu financiamento:
                    </p>
                    
                    <!-- PASSO 1: FGTS -->
                    <div class="passo-container">
                        <div class="passo-numero">
                            <span>1</span>
                        </div>
                        <div class="passo-conteudo">
                            <h3>üè† Use Seu FGTS Agora</h3>
                            
                            <div class="passo-detalhes">
                                <div class="detalhe-item">
                                    <strong>üí∞ Valor:</strong>
                                    <span>R$ ${formatarMoeda(estrategia.fgts_usado)}</span>
                                </div>
                                
                                <div class="detalhe-item">
                                    <strong>üì± Como fazer:</strong>
                                    <ol class="lista-acoes">
                                        <li>Baixe o app <strong>FGTS</strong> (gov.br) no celular</li>
                                        <li>Entre com seu CPF e senha</li>
                                        <li>Clique em <strong>"Amortiza√ß√£o de Financiamento"</strong></li>
                                        <li>Selecione <strong>"Reduzir Presta√ß√£o E Prazo"</strong> (economiza mais!)</li>
                                        <li>Insira o valor: R$ ${formatarMoeda(estrategia.fgts_usado)}</li>
                                        <li>Confirme e aguarde aprova√ß√£o</li>
                                    </ol>
                                </div>
                                
                                <div class="detalhe-item">
                                    <strong>‚è±Ô∏è Prazo:</strong>
                                    <span>5 a 10 dias √∫teis para aprova√ß√£o</span>
                                </div>
                                
                                <div class="detalhe-item destaque-economia">
                                    <strong>‚ú® Economia imediata:</strong>
                                    <span>Reduz o saldo devedor e os juros futuros significativamente</span>
                                </div>
                                
                                <div class="alerta-info">
                                    <i class="fas fa-lightbulb"></i>
                                    <div>
                                        <strong>Dica:</strong> Voc√™ poder√° usar o FGTS novamente daqui a 2 anos para uma nova amortiza√ß√£o!
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PASSO 2: AMORTIZA√á√ÉO MENSAL -->
                    <div class="passo-container">
                        <div class="passo-numero">
                            <span>2</span>
                        </div>
                        <div class="passo-conteudo">
                            <h3>üìÖ Configure Amortiza√ß√£o Mensal Autom√°tica</h3>
                            
                            <div class="passo-detalhes">
                                <div class="detalhe-item">
                                    <strong>üíµ Valor mensal:</strong>
                                    <span>R$ ${formatarMoeda(estrategia.amortizacao_mensal)}</span>
                                </div>
                                
                                <div class="detalhe-item">
                                    <strong>üì± Como configurar:</strong>
                                    <ol class="lista-acoes">
                                        <li>Acesse o app ou internet banking do seu banco</li>
                                        <li>Procure por <strong>"Amortiza√ß√£o Extraordin√°ria"</strong> ou <strong>"Antecipar Parcelas"</strong></li>
                                        <li>Configure d√©bito autom√°tico mensal</li>
                                        <li>Valor: R$ ${formatarMoeda(estrategia.amortizacao_mensal)}</li>
                                        <li>Escolha o melhor dia (recomendamos ap√≥s receber sal√°rio)</li>
                                        <li>Ative a recorr√™ncia autom√°tica</li>
                                    </ol>
                                </div>
                                
                                <div class="detalhe-item">
                                    <strong>‚è≥ Por quanto tempo:</strong>
                                    <span>${estrategia.duracao_amortizacao} meses (${(estrategia.duracao_amortizacao / 12).toFixed(1)} anos)</span>
                                </div>
                                
                                <div class="detalhe-item destaque-economia">
                                    <strong>‚ú® Por que parar aqui?</strong>
                                    <span>Depois de ${estrategia.duracao_amortizacao} meses, o ROI (retorno) diminui. Voc√™ j√° ter√° economizado o m√°ximo poss√≠vel! Pode usar esse dinheiro para outras coisas.</span>
                                </div>
                                
                                <div class="alerta-importante">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <div>
                                        <strong>Importante:</strong> Voc√™ pode pausar ou ajustar o valor a qualquer momento se sua situa√ß√£o financeira mudar.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PASSO 3: MONITORAMENTO -->
                    <div class="passo-container">
                        <div class="passo-numero">
                            <span>3</span>
                        </div>
                        <div class="passo-conteudo">
                            <h3>üìä Monitore Sua Evolu√ß√£o</h3>
                            
                            <div class="passo-detalhes">
                                <div class="detalhe-item">
                                    <strong>üîç A cada 6 meses:</strong>
                                    <ol class="lista-acoes">
                                        <li>Solicite extrato detalhado no banco</li>
                                        <li>Verifique: saldo devedor, juros pagos, prazo restante</li>
                                        <li>Compare com a tabela deste relat√≥rio</li>
                                        <li>Ajuste a estrat√©gia se necess√°rio</li>
                                    </ol>
                                </div>
                                
                                <div class="detalhe-item">
                                    <strong>üìà O que observar:</strong>
                                    <ul class="lista-acoes">
                                        <li><strong>Saldo devedor</strong> deve cair rapidamente nos primeiros anos</li>
                                        <li><strong>Juros mensais</strong> devem diminuir a cada m√™s</li>
                                        <li><strong>Prazo restante</strong> deve ser menor que o original</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PASSO 4: MARCOS -->
                    <div class="passo-container">
                        <div class="passo-numero">
                            <span>4</span>
                        </div>
                        <div class="passo-conteudo">
                            <h3>üéâ Celebre os Marcos Importantes!</h3>
                            
                            <div class="timeline-marcos">
                                <div class="marco">
                                    <div class="marco-tempo">
                                        <i class="fas fa-calendar-check"></i>
                                        <span>1 ano</span>
                                    </div>
                                    <div class="marco-conquista">
                                        <strong>Primeira grande vit√≥ria!</strong>
                                        <p>Voc√™ j√° economizou aproximadamente R$ ${formatarMoeda(estrategia.economia_total * 0.15)} em juros.</p>
                                    </div>
                                </div>
                                
                                <div class="marco">
                                    <div class="marco-tempo">
                                        <i class="fas fa-calendar-check"></i>
                                        <span>${Math.round(estrategia.duracao_amortizacao / 12)} anos</span>
                                    </div>
                                    <div class="marco-conquista">
                                        <strong>Fim das amortiza√ß√µes extras!</strong>
                                        <p>Voc√™ pode parar de amortizar. Continue pagando apenas a parcela normal at√© quitar.</p>
                                    </div>
                                </div>
                                
                                <div class="marco">
                                    <div class="marco-tempo">
                                        <i class="fas fa-trophy"></i>
                                        <span>${Math.round((dadosFinanciamento.prazo_meses - estrategia.reducao_prazo) / 12)} anos</span>
                                    </div>
                                    <div class="marco-conquista">
                                        <strong>üéä FINANCIAMENTO QUITADO!</strong>
                                        <p>Voc√™ economizou <strong>R$ ${formatarMoeda(estrategia.economia_total)}</strong> e quitou <strong>${estrategia.reducao_prazo} meses (${(estrategia.reducao_prazo/12).toFixed(1)} anos) ANTES</strong> do previsto!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ALERTAS IMPORTANTES -->
                    <div class="alertas-importantes">
                        <h3><i class="fas fa-shield-alt"></i> Precau√ß√µes Importantes</h3>
                        
                        <div class="alerta-card alerta-warning">
                            <i class="fas fa-piggy-bank"></i>
                            <div>
                                <strong>Reserva de Emerg√™ncia</strong>
                                <p>Mantenha sempre uma reserva de 6 meses de despesas antes de come√ßar a amortizar agressivamente.</p>
                            </div>
                        </div>
                        
                        <div class="alerta-card alerta-info">
                            <i class="fas fa-percentage"></i>
                            <div>
                                <strong>N√£o Comprometa Tudo</strong>
                                <p>A estrat√©gia usa ${(estrategia.compromisso_mensal_pct || 0).toFixed(0)}% da sua capacidade mensal. Isso deixa ${(100 - (estrategia.compromisso_mensal_pct || 0)).toFixed(0)}% livre para imprevistos e qualidade de vida.</p>
                            </div>
                        </div>
                        
                        <div class="alerta-card alerta-success">
                            <i class="fas fa-pause"></i>
                            <div>
                                <strong>Pode Pausar Quando Precisar</strong>
                                <p>Se enfrentar dificuldades financeiras, voc√™ pode pausar as amortiza√ß√µes extraordin√°rias temporariamente. O importante √© manter o pagamento da parcela normal.</p>
                            </div>
                        </div>
                        
                        <div class="alerta-card alerta-info">
                            <i class="fas fa-redo"></i>
                            <div>
                                <strong>FGTS Renov√°vel</strong>
                                <p>Ap√≥s 2 anos da primeira amortiza√ß√£o, voc√™ pode usar o FGTS novamente para uma nova redu√ß√£o!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GR√ÅFICOS COMPARATIVOS -->
                <div class="chart-container">
                    <h3><i class="fas fa-chart-bar"></i> Comparativo: COM vs SEM EcoFin</h3>
                    
                    <div class="comparison-cards">
                        <div class="comparison-card sem-ecofin">
                            <div class="comparison-header">
                                <i class="fas fa-times-circle"></i>
                                <h4>Sem EcoFin</h4>
                            </div>
                            <div class="comparison-body">
                                <div class="metric">
                                    <span class="label">Total a Pagar:</span>
                                    <span class="value">R$ ${formatarMoeda(cenarioOriginal.total_pago)}</span>
                                </div>
                                <div class="metric">
                                    <span class="label">Total em Juros:</span>
                                    <span class="value">R$ ${formatarMoeda(cenarioOriginal.total_juros)}</span>
                                </div>
                                <div class="metric">
                                    <span class="label">Prazo:</span>
                                    <span class="value">${cenarioOriginal.prazo_meses} meses (${(cenarioOriginal.prazo_meses/12).toFixed(1)} anos)</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="comparison-arrow">
                            <i class="fas fa-arrow-right"></i>
                            <span>Aplique a<br>EcoFin</span>
                        </div>
                        
                        <div class="comparison-card com-ecofin">
                            <div class="comparison-header">
                                <i class="fas fa-check-circle"></i>
                                <h4>Com EcoFin</h4>
                            </div>
                            <div class="comparison-body">
                                <div class="metric">
                                    <span class="label">Total a Pagar:</span>
                                    <span class="value">R$ ${formatarMoeda(estrategia.total_pago)}</span>
                                </div>
                                <div class="metric">
                                    <span class="label">Total em Juros:</span>
                                    <span class="value">R$ ${formatarMoeda(estrategia.total_juros || 0)}</span>
                                </div>
                                <div class="metric">
                                    <span class="label">Prazo:</span>
                                    <span class="value">${estrategia.prazo_meses} meses (${(estrategia.prazo_meses/12).toFixed(1)} anos)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="economia-destaque">
                        <i class="fas fa-trophy"></i>
                        <div>
                            <strong>Voc√™ Economiza:</strong>
                            <span class="valor-economia">R$ ${formatarMoeda(estrategia.economia_total)}</span>
                            <span class="percentual-economia">(${((estrategia.economia_total / cenarioOriginal.total_pago) * 100).toFixed(1)}% de economia!)</span>
                        </div>
                    </div>
                    
                    <canvas id="chartComparativoBarras" style="margin-top: 30px; height: 400px;"></canvas>
                </div>

                <!-- CEN√ÅRIOS ALTERNATIVOS -->
                ${cenariosAlternativos.length >= 3 ? `
                <div class="alternative-scenarios">
                    <h2><i class="fas fa-lightbulb"></i> Outras Op√ß√µes para Voc√™ Considerar</h2>
                    <p class="subtitle">
                        A estrat√©gia recomendada √© a melhor, mas voc√™ pode preferir uma destas alternativas 
                        dependendo da sua situa√ß√£o financeira atual:
                    </p>
                    
                    <div class="scenarios-grid">
                        ${cenariosAlternativos.slice(0, 3).map((cenario, index) => {
                            const tipos = ['equilibrio', 'conservador', 'agressivo'];
                            const badges = [
                                { class: '', text: 'RECOMENDADO', icon: 'star' },
                                { class: 'scenario-badge-blue', text: 'CONSERVADOR', icon: 'shield-alt' },
                                { class: 'scenario-badge-orange', text: 'AGRESSIVO', icon: 'rocket' }
                            ];
                            const titulos = ['Equil√≠brio Perfeito', 'Mais Seguro', 'M√°xima Economia'];
                            const subti = ['Melhor custo-benef√≠cio', 'Menor comprometimento mensal', 'Quitar o mais r√°pido poss√≠vel'];
                            
                            return `
                            <div class="scenario-card ${index === 0 ? 'scenario-recommended' : ''}">
                                <div class="scenario-badge ${badges[index].class}">
                                    <i class="fas fa-${badges[index].icon}"></i>
                                    <span>${badges[index].text}</span>
                                </div>
                                
                                <div class="scenario-header">
                                    <h3>Op√ß√£o ${index + 1}: ${titulos[index]}</h3>
                                    <p class="scenario-type">${subti[index]}</p>
                                </div>
                                
                                <div class="scenario-body">
                                    <div class="scenario-params">
                                        <div class="param">
                                            <i class="fas fa-hand-holding-usd"></i>
                                            <div>
                                                <strong>FGTS:</strong>
                                                <span>R$ ${formatarMoeda(cenario.fgts_usado)} (${cenario.fgts_percentual}%)</span>
                                            </div>
                                        </div>
                                        
                                        <div class="param">
                                            <i class="fas fa-calendar-alt"></i>
                                            <div>
                                                <strong>Amortiza√ß√£o Mensal:</strong>
                                                <span>R$ ${formatarMoeda(cenario.amortizacao_mensal)} por ${cenario.duracao_amortizacao} meses</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="scenario-results">
                                        <div class="result-item">
                                            <span class="label">Economia:</span>
                                            <span class="value highlight-green">R$ ${formatarMoeda(cenario.economia_total)}</span>
                                        </div>
                                        <div class="result-item">
                                            <span class="label">ROI:</span>
                                            <span class="value">${cenario.roi.toFixed(2)}x</span>
                                        </div>
                                        <div class="result-item">
                                            <span class="label">Viabilidade:</span>
                                            <span class="value viabilidade-${cenario.viabilidade.toLowerCase()}">${cenario.viabilidade}</span>
                                        </div>
                                        <div class="result-item">
                                            <span class="label">Quita em:</span>
                                            <span class="value">${(cenario.prazo_meses / 12).toFixed(1)} anos</span>
                                        </div>
                                    </div>
                                    
                                    <div class="scenario-explanation">
                                        <strong>Por que escolher esta?</strong>
                                        <p>${getExplicacaoCenario(cenario, tipos[index])}</p>
                                    </div>
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- TABELA COMPARATIVA -->
                    <div class="comparison-table-container">
                        <h3><i class="fas fa-table"></i> Compara√ß√£o R√°pida das 3 Op√ß√µes</h3>
                        <table class="comparison-table">
                            <thead>
                                <tr>
                                    <th>Crit√©rio</th>
                                    <th>Op√ß√£o 1<br><small>(Recomendada)</small></th>
                                    <th>Op√ß√£o 2<br><small>(Conservadora)</small></th>
                                    <th>Op√ß√£o 3<br><small>(Agressiva)</small></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>üí∞ Economia Total</td>
                                    ${cenariosAlternativos.slice(0, 3).map(c => `<td>R$ ${formatarMoeda(c.economia_total)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>üìà ROI (Retorno)</td>
                                    ${cenariosAlternativos.slice(0, 3).map(c => `<td>${c.roi.toFixed(2)}x</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>üí≥ Investimento Mensal</td>
                                    ${cenariosAlternativos.slice(0, 3).map(c => `<td>R$ ${formatarMoeda(c.amortizacao_mensal)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>‚è±Ô∏è Tempo Amortizando</td>
                                    ${cenariosAlternativos.slice(0, 3).map(c => `<td>${(c.duracao_amortizacao / 12).toFixed(1)} anos</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>üéØ Viabilidade</td>
                                    ${cenariosAlternativos.slice(0, 3).map(c => `<td class="viabilidade-${c.viabilidade.toLowerCase()}">${c.viabilidade}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td>üèÅ Prazo Total</td>
                                    ${cenariosAlternativos.slice(0, 3).map(c => `<td>${(c.prazo_meses / 12).toFixed(1)} anos</td>`).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                ` : ''}

                <!-- BOT√ÉO DOWNLOAD -->
                <button class="btn-download" onclick="gerarPDF()">
                    <i class="fas fa-file-pdf"></i>
                    Baixar Relat√≥rio Completo (PDF)
                </button>
            `;

            // Criar gr√°fico comparativo
            setTimeout(() => {
                criarGraficoComparativoBarras(cenarioOriginal, estrategia);
            }, 100);
        }

        function criarGraficoComparativoBarras(cenarioOriginal, estrategia) {
            const ctx = document.getElementById('chartComparativoBarras');
            
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Total Pago', 'Total em Juros', 'Prazo (anos)'],
                    datasets: [
                        {
                            label: 'Sem EcoFin',
                            data: [
                                cenarioOriginal.total_pago,
                                cenarioOriginal.total_juros,
                                cenarioOriginal.prazo_meses / 12
                            ],
                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                            borderColor: '#e74c3c',
                            borderWidth: 2
                        },
                        {
                            label: 'Com EcoFin',
                            data: [
                                estrategia.total_pago,
                                estrategia.total_juros || 0,
                                estrategia.prazo_meses / 12
                            ],
                            backgroundColor: 'rgba(46, 204, 113, 0.7)',
                            borderColor: '#2ecc71',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Compara√ß√£o Detalhada: Antes e Depois',
                            color: '#daa520',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#fff',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataIndex === 2) {
                                        label += context.parsed.y.toFixed(1) + ' anos';
                                    } else {
                                        label += 'R$ ' + context.parsed.y.toLocaleString('pt-BR', {
                                            minimumFractionDigits: 2,
                                            maximumFractionDigits: 2
                                        });
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#fff',
                                callback: function(value) {
                                    if (value >= 1000) {
                                        return 'R$ ' + (value / 1000).toFixed(0) + 'k';
                                    }
                                    return 'R$ ' + value;
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function gerarPDF() {
            alert('Funcionalidade de gera√ß√£o de PDF ser√° implementada em breve!');
        }

        // Carregar dashboard ao carregar a p√°gina
        window.addEventListener('DOMContentLoaded', carregarDashboard);
    </script>
</body>
</html>
