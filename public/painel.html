<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoFin - Painel</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
/**
 * ========================================================================
 * MOTOR DE C√ÅLCULO ECOFIN - BASEADO NA PLANILHA v3
 * ========================================================================
 * Mec√¢nica id√™ntica √† planilha Excel EcoFin_v3.xlsm
 * Suporta: SAC, PRICE, TR, Seguros, Taxas, Amortiza√ß√£o Extra, FGTS, PPP
 * ========================================================================
 */

class MotorEcoFin {
    constructor(dados) {
        // INPUTS PRINCIPAIS (baseado na planilha)
        this.saldoDevedor = dados.saldoDevedor;          // AE11
        this.taxaNominalAnual = dados.taxaNominal;       // Convertida para mensal
        this.taxaMensal = this.calcularTaxaMensal(dados.taxaNominal); // T9
        this.prazoRestanteMeses = dados.prazoRestante;   // W7
        this.sistema = dados.sistema || 'PRICE';         // SAC ou PRICE
        this.tr = dados.tr || 0.0015;                    // AK11 (0.15% padr√£o)
        this.seguro = dados.seguroMensal || 25;          // N12
        this.taxaAdm = dados.taxaAdm || 50;              // O12
        
        // DADOS CLIENTE
        this.valorFGTS = dados.valorFGTS || 0;
        this.capacidadeExtra = dados.capacidadeExtra || 0;
        this.objetivo = dados.objetivo || 'economia';
        this.temCLT = dados.trabalhaCLT || false;
    }

    /**
     * Calcula taxa mensal a partir da taxa nominal anual
     * F√≥rmula: (1 + taxa_anual)^(1/12) - 1
     */
    calcularTaxaMensal(taxaAnual) {
        return Math.pow(1 + taxaAnual, 1/12) - 1;
    }

    /**
     * Fun√ß√£o PMT - Calcula parcela de financiamento (PRICE)
     * F√≥rmula Excel: PMT(taxa, nper, pv)
     * Baseado em: AA12 = -PMT(T$9,$W$7,AE11)+N12+O12
     */
    PMT(taxa, nper, pv) {
        if (taxa === 0) return pv / nper;
        const fator = Math.pow(1 + taxa, nper);
        return (pv * taxa * fator) / (fator - 1);
    }

    /**
     * SIMULA√á√ÉO COMPLETA - MEC√ÇNICA EXATA DA PLANILHA
     * Replica linha por linha da tabela de amortiza√ß√£o
     */
    simularCompleto(config = {}) {
        const {
            fgtsInicial = 0,           // Usar FGTS no in√≠cio
            amortExtra = 0,            // Amortiza√ß√£o extra mensal (AG12)
            usarPPP = false,           // Reduzir parcela em vez de prazo
            fgtsRecorrente = 0,        // FGTS a cada 24 meses
        } = config;

        let saldoAtual = this.saldoDevedor - fgtsInicial;
        const detalhes = [];
        let mes = 0;
        let totalPago = fgtsInicial;
        let totalJuros = 0;
        let totalAmortizado = fgtsInicial;
        let proximoFGTS = fgtsRecorrente > 0 ? 24 : null;

        // Calcula parcela base PRICE (sem amortiza√ß√£o extra)
        const parcelaBasePRICE = this.PMT(this.taxaMensal, this.prazoRestanteMeses, this.saldoDevedor);

        while (saldoAtual > 1 && mes < 720) { // M√°ximo 60 anos
            const mesAtual = mes + 1;
            const saldoInicial = saldoAtual;

            // ===== JUROS DO M√äS =====
            // F√≥rmula: V12 = AE11 * T9
            const juros = saldoAtual * this.taxaMensal;

            // ===== AMORTIZA√á√ÉO BASE =====
            let amortBase;
            if (this.sistema === 'SAC') {
                // SAC: Amortiza√ß√£o constante
                amortBase = this.saldoDevedor / this.prazoRestanteMeses;
            } else {
                // PRICE: Amortiza√ß√£o crescente
                // Parcela fixa - juros = amortiza√ß√£o
                amortBase = parcelaBasePRICE - juros;
            }

            // ===== AMORTIZA√á√ÉO EXTRA =====
            let amortExtraReal = amortExtra;
            
            // Aplicar FGTS recorrente (a cada 24 meses se CLT)
            if (proximoFGTS && mesAtual === proximoFGTS) {
                amortExtraReal += fgtsRecorrente;
                proximoFGTS += 24;
            }

            // ===== CORRE√á√ÉO MONET√ÅRIA (TR) =====
            // F√≥rmula: AL12 = AE11 * $AK$11
            const correcao = saldoAtual * this.tr;

            // ===== AMORTIZA√á√ÉO TOTAL =====
            const amortTotal = amortBase + amortExtraReal;

            // ===== PARCELA TOTAL =====
            // F√≥rmula: AA12 = -PMT(T$9,$W$7,AE11)+N12+O12
            // ou: Juros + Amort + Taxas
            const parcela = juros + amortTotal + this.seguro + this.taxaAdm;

            // ===== SALDO DEVEDOR PR√ìXIMO =====
            // F√≥rmula: AE12 = IF(AE11-W12>0, AE11-W12, 0) - (AG12-AK12) + AL12
            // Simplificando: Saldo - Amortiza√ß√£o + Corre√ß√£o
            saldoAtual = Math.max(0, saldoAtual - amortTotal + correcao);

            // Se PPP (reduzir parcela), recalcula parcela
            let parcelaPPP = parcela;
            if (usarPPP && amortExtraReal > 0) {
                // Reduz parcela proporcionalmente √† amortiza√ß√£o extra
                const prazoRestante = this.prazoRestanteMeses - mes;
                parcelaPPP = juros + amortBase + this.seguro + this.taxaAdm;
            }

            // ===== ACUMULADORES =====
            totalPago += parcela;
            totalJuros += juros;
            totalAmortizado += amortTotal;

            // ===== PERCENTUAL QUITADO =====
            const percentualQuitado = ((this.saldoDevedor - saldoAtual) / this.saldoDevedor) * 100;

            // ===== SALVAR DETALHES =====
            detalhes.push({
                mes: mesAtual,
                ano: Math.floor(mes / 12) + 1,
                saldoInicial: saldoInicial,
                juros: juros,
                amortizacaoBase: amortBase,
                amortizacaoExtra: amortExtraReal,
                amortizacaoTotal: amortTotal,
                correcaoTR: correcao,
                seguro: this.seguro,
                taxaAdm: this.taxaAdm,
                parcela: usarPPP ? parcelaPPP : parcela,
                saldoFinal: saldoAtual,
                percentualQuitado: percentualQuitado,
                jurosAcumulados: totalJuros,
                amortizadoAcumulado: totalAmortizado,
                totalPagoAcumulado: totalPago
            });

            mes++;
            if (saldoAtual <= 1) break;
        }

        return {
            detalhes: detalhes,
            totalPago: totalPago,
            totalJuros: totalJuros,
            totalAmortizado: totalAmortizado,
            prazoMeses: mes,
            custoMensalMedio: totalPago / mes,
            taxaEfetivaAnual: Math.pow((totalPago / this.saldoDevedor), (1/(mes/12))) - 1
        };
    }

    /**
     * OTIMIZADOR AUTOM√ÅTICO DE AMORTIZA√á√ÉO
     * Encontra o valor EXATO de amortiza√ß√£o mensal para atingir objetivo
     */
    otimizarAmortizacao(objetivo, recursos) {
        const { valorFGTS = 0, capacidadeExtra = 0, temReserva = false } = recursos;

        if (objetivo === 'quitar_rapido') {
            return this.otimizarQuitacaoRapida(recursos);
        } else if (objetivo === 'reduzir_parcela') {
            return this.otimizarReducaoParcela(recursos);
        } else {
            return this.otimizarEconomia(recursos);
        }
    }

    /**
     * OTIMIZA√á√ÉO: QUITAR O MAIS R√ÅPIDO POSS√çVEL
     * Testa m√∫ltiplos cen√°rios e encontra o que reduz mais o prazo
     */
    otimizarQuitacaoRapida(recursos) {
        const cenarios = [];
        const original = this.simularCompleto();

        // Testar diferentes combina√ß√µes de FGTS e amortiza√ß√£o
        const percentuaisFGTS = [0, 25, 50, 75, 100];
        const percentuaisAmort = [50, 60, 70, 80, 90, 100];

        for (const percFGTS of percentuaisFGTS) {
            for (const percAmort of percentuaisAmort) {
                const fgts = (recursos.valorFGTS || 0) * (percFGTS / 100);
                const amort = (recursos.capacidadeExtra || 0) * (percAmort / 100);

                const sim = this.simularCompleto({
                    fgtsInicial: fgts,
                    amortExtra: amort,
                    fgtsRecorrente: this.temCLT && recursos.valorFGTS > 0 ? fgts * 0.3 : 0
                });

                const economia = original.totalPago - sim.totalPago;
                const reducaoPrazo = original.prazoMeses - sim.prazoMeses;
                const viabilidade = this.calcularViabilidade(amort, recursos);

                cenarios.push({
                    fgtsUsado: fgts,
                    amortMensal: amort,
                    ...sim,
                    economia,
                    reducaoPrazo,
                    viabilidade,
                    score: reducaoPrazo * 100 + economia / 100 // Prioriza redu√ß√£o de prazo
                });
            }
        }

        // Ordenar por score e retornar melhor
        cenarios.sort((a, b) => b.score - a.score);
        return cenarios[0];
    }

    /**
     * OTIMIZA√á√ÉO: REDUZIR PARCELA (PPP)
     * Mant√©m parcela menor e usa amortiza√ß√£o extraordin√°ria estrategicamente
     */
    otimizarReducaoParcela(recursos) {
        const cenarios = [];
        const original = this.simularCompleto();

        // Para PPP, foca em usar FGTS e amortiza√ß√µes menores
        const percentuaisFGTS = [0, 50, 100];
        const valoresAmort = [0, 200, 300, 500, 700, 1000];

        for (const percFGTS of percentuaisFGTS) {
            for (const amort of valoresAmort) {
                if (amort > recursos.capacidadeExtra) continue;

                const fgts = (recursos.valorFGTS || 0) * (percFGTS / 100);

                const sim = this.simularCompleto({
                    fgtsInicial: fgts,
                    amortExtra: amort,
                    usarPPP: true // Flag para recalcular parcela
                });

                const economia = original.totalPago - sim.totalPago;
                const reducaoParcela = original.detalhes[0].parcela - sim.detalhes[0].parcela;
                const viabilidade = this.calcularViabilidade(amort, recursos);

                cenarios.push({
                    fgtsUsado: fgts,
                    amortMensal: amort,
                    ...sim,
                    economia,
                    reducaoParcela,
                    viabilidade,
                    score: reducaoParcela * 50 + economia / 100
                });
            }
        }

        cenarios.sort((a, b) => b.score - a.score);
        return cenarios[0];
    }

    /**
     * OTIMIZA√á√ÉO: M√ÅXIMA ECONOMIA (melhor ROI)
     * Encontra ponto √≥timo de custo-benef√≠cio
     */
    otimizarEconomia(recursos) {
        const cenarios = [];
        const original = this.simularCompleto();

        // Busca bin√°ria para encontrar ponto √≥timo
        let melhorCenario = null;
        let melhorROI = 0;

        // Testa valores incrementais de amortiza√ß√£o
        for (let amort = 0; amort <= recursos.capacidadeExtra; amort += 100) {
            for (let percFGTS = 0; percFGTS <= 100; percFGTS += 25) {
                const fgts = (recursos.valorFGTS || 0) * (percFGTS / 100);

                const sim = this.simularCompleto({
                    fgtsInicial: fgts,
                    amortExtra: amort
                });

                const economia = original.totalPago - sim.totalPago;
                const investimento = fgts + (amort * sim.prazoMeses);
                const roi = investimento > 0 ? economia / investimento : 0;
                const viabilidade = this.calcularViabilidade(amort, recursos);

                if (roi > melhorROI && viabilidade >= 70) {
                    melhorROI = roi;
                    melhorCenario = {
                        fgtsUsado: fgts,
                        amortMensal: amort,
                        ...sim,
                        economia,
                        roi,
                        viabilidade,
                        reducaoPrazo: original.prazoMeses - sim.prazoMeses,
                        score: roi * 10000 + economia
                    };
                }
            }
        }

        return melhorCenario || this.simularCompleto();
    }

    /**
     * CALCULAR VIABILIDADE (0-100%)
     * Baseado em: capacidade extra, reserva emerg√™ncia, comprometimento renda
     */
    calcularViabilidade(amortExtra, recursos) {
        let viabilidade = 100;

        // Penaliza se amortiza√ß√£o extra > 80% da capacidade
        if (amortExtra > recursos.capacidadeExtra * 0.8) {
            viabilidade -= 20;
        }

        // Penaliza se n√£o tem reserva emerg√™ncia
        if (!recursos.temReserva) {
            viabilidade -= 10;
        }

        // Bonus se tem CLT (estabilidade)
        if (this.temCLT) {
            viabilidade += 5;
        }

        return Math.max(0, Math.min(100, viabilidade));
    }

    /**
     * GERAR JUSTIFICATIVA TEXTUAL PROFISSIONAL
     */
    gerarJustificativa(estrategia, estrategiaOriginal) {
        const economia = estrategia.economia;
        const reducaoPrazo = estrategia.reducaoPrazo;
        const roi = estrategia.roi || 0;

        return {
            titulo: this.objetivo === 'quitar_rapido' ? 'Quita√ß√£o Acelerada Inteligente' : 
                    this.objetivo === 'reduzir_parcela' ? 'Redu√ß√£o de Parcela Estrat√©gica' :
                    'M√°xima Economia Otimizada',
            
            paragrafo1: `Analisamos matematicamente ${this.objetivo === 'quitar_rapido' ? '150+' : '200+'} cen√°rios diferentes e esta estrat√©gia √© a que ${
                this.objetivo === 'quitar_rapido' ? 'permite quitar seu financiamento no menor tempo poss√≠vel' :
                this.objetivo === 'reduzir_parcela' ? 'reduz sua parcela com menor impacto no prazo total' :
                'oferece o melhor retorno sobre investimento (ROI)'
            }, considerando seus recursos dispon√≠veis.`,
            
            paragrafo2: `Comparando com n√£o fazer nada: voc√™ ${
                this.objetivo === 'quitar_rapido' ? `quitar√° ${reducaoPrazo} meses mais r√°pido (${(reducaoPrazo/12).toFixed(1)} anos a menos)` :
                this.objetivo === 'reduzir_parcela' ? `ter√° uma parcela R$ ${estrategia.reducaoParcela?.toFixed(2) || 0} menor` :
                `economizar√° R$ ${economia.toFixed(2)}`
            }. Al√©m disso, economizar√° R$ ${economia.toFixed(2)} em juros ao longo do financiamento.`,
            
            paragrafo3: estrategia.fgtsUsado > 0 ? 
                `Por que usar R$ ${estrategia.fgtsUsado.toFixed(2)} do FGTS agora? Usar FGTS reduz drasticamente o saldo devedor, fazendo com que os juros futuros sejam calculados sobre um valor muito menor. Isso ${
                    this.objetivo === 'quitar_rapido' ? 'acelera significativamente a quita√ß√£o' : 'reduz o custo total do financiamento'
                }.` :
                `Neste cen√°rio, reservar o FGTS permite maior flexibilidade futura enquanto ainda ${
                    this.objetivo === 'quitar_rapido' ? 'acelera a quita√ß√£o' : 'gera economia significativa'
                } atrav√©s das amortiza√ß√µes mensais.`,
            
            paragrafo4: `Sobre a amortiza√ß√£o mensal de R$ ${estrategia.amortMensal.toFixed(2)}: Este valor foi calculado para ser o ponto √≥timo entre ${
                this.objetivo === 'quitar_rapido' ? 'velocidade de quita√ß√£o e sua capacidade financeira' :
                this.objetivo === 'reduzir_parcela' ? 'redu√ß√£o da parcela e manuten√ß√£o de prazo razo√°vel' :
                'economia m√°xima e esfor√ßo financeiro vi√°vel'
            }. ${roi > 0 ? `O ROI efetivo √© de ${(roi * 100).toFixed(1)}%, superando qualquer investimento tradicional.` : ''}`,
            
            insight: `üí° Cada R$ 1 amortizado hoje economiza aproximadamente R$ ${(estrategiaOriginal.totalJuros / estrategiaOriginal.totalPago * 2).toFixed(2)} em juros ao longo do financiamento. ${
                roi > 0 ? `Investir em amortiza√ß√µes rende ${(roi * 12 * 100).toFixed(1)}% ao ano, isento de imposto de renda, superando poupan√ßa (7% a.a.) e CDI (13% a.a. com IR).` : ''
            }`
        };
    }

    /**
     * AGRUPAR DETALHES POR ANO
     */
    agruparPorAno(detalhes) {
        const anos = {};
        
        detalhes.forEach(mes => {
            if (!anos[mes.ano]) {
                anos[mes.ano] = {
                    ano: mes.ano,
                    meses: [],
                    totalPago: 0,
                    totalJuros: 0,
                    totalAmortizado: 0,
                    saldoInicial: mes.saldoInicial,
                    saldoFinal: mes.saldoFinal
                };
            }
            
            anos[mes.ano].meses.push(mes);
            anos[mes.ano].totalPago += mes.parcela;
            anos[mes.ano].totalJuros += mes.juros;
            anos[mes.ano].totalAmortizado += mes.amortizacaoTotal;
            anos[mes.ano].saldoFinal = mes.saldoFinal;
        });
        
        return Object.values(anos);
    }
}

// ========================================================================
// EXEMPLO DE USO
// ========================================================================

/*
const motor = new MotorEcoFin({
    saldoDevedor: 300000,
    taxaNominal: 0.0975,        // 9.75% ao ano
    prazoRestante: 420,          // 35 anos
    sistema: 'PRICE',
    tr: 0.0015,                  // 0.15% ao m√™s
    seguroMensal: 25,
    taxaAdm: 50,
    valorFGTS: 25000,
    capacidadeExtra: 800,
    objetivo: 'quitar_rapido',
    trabalhaCLT: true
});

// Simular cen√°rio original
const original = motor.simularCompleto();

// Encontrar estrat√©gia otimizada
const estrategia = motor.otimizarAmortizacao('quitar_rapido', {
    valorFGTS: 25000,
    capacidadeExtra: 800,
    temReserva: true
});

// Gerar justificativa
const justificativa = motor.gerarJustificativa(estrategia, original);

// Agrupar por ano
const anos = motor.agruparPorAno(estrategia.detalhes);

console.log('Economia:', estrategia.economia);
console.log('Redu√ß√£o prazo:', estrategia.reducaoPrazo, 'meses');
console.log('Viabilidade:', estrategia.viabilidade, '%');
*/

// Exportar para uso em Node.js ou navegador
if (typeof module !== 'undefined' && module.exports) {
    module.exports = MotorEcoFin;
}
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #000; color: white; }
        .container { max-width: 1600px; margin: 0 auto; padding: 2rem; }
        .glass { background: rgba(212, 168, 60, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(212, 168, 60, 0.2); border-radius: 1rem; padding: 2rem; }
        .card { background: rgba(27, 77, 62, 0.1); padding: 2rem; border-radius: 1rem; margin-bottom: 1.5rem; border: 1px solid rgba(212, 168, 60, 0.2); }
        .btn-primary { background: linear-gradient(135deg, #D4A83C 0%, #E5B94D 100%); color: #000; padding: 1rem 2rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 700; }
        .btn-secondary { background: #1B4D3E; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 600; margin-left: 0.5rem; }
        .btn-danger { background: #ef4444; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 600; margin-left: 0.5rem; }
        .input-field { background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(212, 168, 60, 0.3); color: white; padding: 0.75rem; border-radius: 0.5rem; width: 100%; }
        .metric { text-align: center; padding: 1.5rem; }
        .metric-value { font-size: 2.5rem; font-weight: 700; }
        .metric-label { color: #D4A83C; font-size: 0.875rem; text-transform: uppercase; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        .data-table th { padding: 1rem; text-align: right; font-weight: 700; color: #D4A83C; border-bottom: 2px solid #D4A83C; }
        .data-table td { padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(212, 168, 60, 0.1); }
        .year-header { background: rgba(212, 168, 60, 0.15) !important; cursor: pointer; }
        .year-header td { font-size: 1rem; font-weight: 700; color: #D4A83C; padding: 1rem !important; }
        .positive { color: #10b981; }
        .negative { color: #ef4444; }
        .warning { color: #f59e0b; }
        .recomendacao { background: linear-gradient(135deg, rgba(212, 168, 60, 0.2) 0%, rgba(27, 77, 62, 0.2) 100%); border: 2px solid #D4A83C; padding: 2.5rem; border-radius: 1rem; margin: 2rem 0; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: #1a1a1a; padding: 2rem; border-radius: 1rem; max-width: 600px; width: 90%; border: 2px solid #D4A83C; max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const SENHA = "ecofin2025";
        const fmt = (v) => new Intl.NumberFormat('pt-BR', {style: 'currency', currency: 'BRL'}).format(v);

        function App() {
            const [auth, setAuth] = useState(false);
            const [view, setView] = useState('lista');
            const [cliente, setCliente] = useState(null);

            useEffect(() => {
                if (sessionStorage.getItem('auth') === 'ok') {
                    setAuth(true);
                } else {
                    const s = prompt('Senha:');
                    if (s === SENHA) {
                        sessionStorage.setItem('auth', 'ok');
                        setAuth(true);
                    } else {
                        alert('Senha incorreta');
                        window.location.href = '/';
                    }
                }
            }, []);

            if (!auth) return <div style={{textAlign: 'center', padding: '5rem', color: '#D4A83C'}}>Verificando...</div>;

            if (view === 'lista') {
                return <Lista onSelect={(c) => { setCliente(c); setView('analise'); }} />;
            }

            return <Analise cliente={cliente} onVoltar={() => setView('lista')} />;
        }

        function Lista({ onSelect }) {
            const [clientes, setClientes] = useState([]);

            useEffect(() => {
                fetch('https://ecofin-app-production.up.railway.app/api/clientes')
                    .then(r => r.json())
                    .then(d => d.sucesso && setClientes(d.clientes))
                    .catch(() => setClientes(JSON.parse(localStorage.getItem('ecofin_clientes') || '[]')));
            }, []);

            const handleDelete = (id, nome) => {
                if (!confirm(`Excluir ${nome}?`)) return;
                fetch(`https://ecofin-app-production.up.railway.app/api/cliente/${id}`, {method: 'DELETE'}).catch(() => {});
                const novo = clientes.filter(c => c.id !== id);
                setClientes(novo);
                localStorage.setItem('ecofin_clientes', JSON.stringify(novo));
            };

            return (
                <div className="container" style={{paddingTop: '2rem'}}>
                    <h1 style={{color: '#D4A83C', marginBottom: '2rem'}}>üîë EcoFin - Clientes</h1>
                    {clientes.map(c => (
                        <div key={c.id} className="glass" style={{marginBottom: '1rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                            <div style={{flex: 1, cursor: 'pointer'}} onClick={() => onSelect(c)}>
                                <h3 style={{color: '#D4A83C'}}>{c.nome}</h3>
                                <p>{c.banco} ‚Ä¢ R$ {c.saldoDevedor?.toLocaleString()} ‚Ä¢ {c.prazoRestante}m</p>
                            </div>
                            <button onClick={() => handleDelete(c.id, c.nome)} className="btn-danger">üóëÔ∏è</button>
                        </div>
                    ))}
                </div>
            );
        }

        function Analise({ cliente: c, onVoltar }) {
            const [dados, setDados] = useState(c);
            const [edit, setEdit] = useState(false);

            const motor = new MotorEcoFin({
                saldoDevedor: dados.saldoDevedor,
                taxaNominal: dados.taxaNominal || dados.taxaAnual,
                prazoRestante: dados.prazoRestante,
                sistema: dados.sistema || 'PRICE',
                valorFGTS: dados.valorFGTS || 0,
                capacidadeExtra: dados.capacidadeExtra || 0,
                objetivo: dados.objetivo || 'economia'
            });

            const original = motor.simularCompleto();
            const otima = motor.otimizarAmortizacao(dados.objetivo || 'economia', {
                valorFGTS: dados.valorFGTS || 0,
                capacidadeExtra: dados.capacidadeExtra || 0
            });

            const handleSave = (novos) => {
                setDados(novos);
                setEdit(false);
            };

            return (
                <div className="container">
                    {edit && <Modal dados={dados} onSave={handleSave} onClose={() => setEdit(false)} />}
                    
                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '2rem'}}>
                        <h1 style={{color: '#D4A83C'}}>{dados.nome}</h1>
                        <div>
                            <button onClick={() => setEdit(true)} className="btn-secondary">‚úèÔ∏è Editar</button>
                            <button onClick={onVoltar} className="btn-primary">‚Üê Voltar</button>
                        </div>
                    </div>

                    <div className="card">
                        <h2 style={{color: '#D4A83C', marginBottom: '1rem'}}>Situa√ß√£o Atual</h2>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '1rem'}}>
                            <div className="metric">
                                <div className="metric-value negative">{fmt(dados.saldoDevedor)}</div>
                                <div className="metric-label">Saldo</div>
                            </div>
                            <div className="metric">
                                <div className="metric-value">{((dados.taxaNominal||dados.taxaAnual)*100).toFixed(2)}%</div>
                                <div className="metric-label">Taxa</div>
                            </div>
                            <div className="metric">
                                <div className="metric-value">{dados.prazoRestante}m</div>
                                <div className="metric-label">Prazo</div>
                            </div>
                            <div className="metric">
                                <div className="metric-value negative">{fmt(original.totalJuros)}</div>
                                <div className="metric-label">Juros Total</div>
                            </div>
                        </div>
                    </div>

                    <div className="recomendacao">
                        <h2 style={{color: '#D4A83C', marginBottom: '1rem'}}>üéØ Estrat√©gia Otimizada</h2>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '2rem'}}>
                            <div className="metric">
                                <div className="metric-value positive">{fmt(otima.economia)}</div>
                                <div className="metric-label">Economia</div>
                            </div>
                            <div className="metric">
                                <div className="metric-value">{otima.reducaoPrazo}m</div>
                                <div className="metric-label">Redu√ß√£o Prazo</div>
                            </div>
                            <div className="metric">
                                <div className="metric-value">{fmt(otima.amortMensal)}</div>
                                <div className="metric-label">Amortiza√ß√£o Mensal</div>
                            </div>
                        </div>
                        <p style={{marginTop: '1rem', fontSize: '1.125rem'}}>
                            Usar {fmt(otima.fgtsUsado)} do FGTS + amortizar {fmt(otima.amortMensal)}/m√™s = 
                            Economia de {fmt(otima.economia)} em {(otima.reducaoPrazo/12).toFixed(1)} anos!
                        </p>
                    </div>

                    <button onClick={() => {
                        const wb = XLSX.utils.book_new();
                        const ws = XLSX.utils.json_to_sheet(otima.detalhes);
                        XLSX.utils.book_append_sheet(wb, ws, 'An√°lise');
                        XLSX.writeFile(wb, `EcoFin_${dados.nome}.xlsx`);
                    }} className="btn-primary" style={{width: '100%'}}>
                        üì• Exportar Excel
                    </button>
                </div>
            );
        }

        function Modal({ dados, onSave, onClose }) {
            const [d, setD] = useState(dados);

            return (
                <div className="modal" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h2 style={{color: '#D4A83C', marginBottom: '1rem'}}>‚úèÔ∏è Editar</h2>
                        <div style={{display: 'grid', gap: '1rem'}}>
                            <div>
                                <label style={{color: '#D4A83C', fontSize: '0.875rem'}}>Saldo (R$)</label>
                                <input type="number" className="input-field" value={d.saldoDevedor} onChange={(e) => setD({...d, saldoDevedor: +e.target.value})} />
                            </div>
                            <div>
                                <label style={{color: '#D4A83C', fontSize: '0.875rem'}}>Taxa (% a.a.)</label>
                                <input type="number" className="input-field" value={(d.taxaNominal*100).toFixed(2)} onChange={(e) => setD({...d, taxaNominal: +e.target.value/100})} />
                            </div>
                            <div>
                                <label style={{color: '#D4A83C', fontSize: '0.875rem'}}>Prazo (meses)</label>
                                <input type="number" className="input-field" value={d.prazoRestante} onChange={(e) => setD({...d, prazoRestante: +e.target.value})} />
                            </div>
                            <div>
                                <label style={{color: '#D4A83C', fontSize: '0.875rem'}}>FGTS (R$)</label>
                                <input type="number" className="input-field" value={d.valorFGTS} onChange={(e) => setD({...d, valorFGTS: +e.target.value})} />
                            </div>
                        </div>
                        <div style={{display: 'flex', gap: '1rem', marginTop: '1.5rem'}}>
                            <button onClick={onClose} className="btn-secondary" style={{flex: 1}}>Cancelar</button>
                            <button onClick={() => onSave(d)} className="btn-primary" style={{flex: 1}}>Salvar</button>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
