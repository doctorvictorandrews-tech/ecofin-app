<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoFin - Painel Integrado API</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #000 0%, #0a1f1a 100%); color: white; }
        .container { max-width: 1600px; margin: 0 auto; padding: 2rem; }
        .glass { background: rgba(212, 168, 60, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(212, 168, 60, 0.2); border-radius: 1rem; padding: 2rem; }
        .card { background: rgba(27, 77, 62, 0.1); padding: 2rem; border-radius: 1rem; margin-bottom: 1.5rem; border: 1px solid rgba(212, 168, 60, 0.2); }
        .btn-primary { background: linear-gradient(135deg, #D4A83C 0%, #E5B94D 100%); color: #000; padding: 1rem 2rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 700; transition: all 0.3s; font-size: 1rem; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(212, 168, 60, 0.4); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: #1B4D3E; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 600; margin-left: 0.5rem; transition: all 0.3s; }
        .btn-secondary:hover { background: #2a6b50; }
        .btn-danger { background: #ef4444; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 600; margin-left: 0.5rem; transition: all 0.3s; }
        .btn-danger:hover { background: #dc2626; }
        .metric { text-align: center; padding: 1.5rem; }
        .metric-value { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; line-height: 1.2; }
        .metric-label { color: #D4A83C; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .positive { color: #10b981; }
        .negative { color: #ef4444; }
        .warning { color: #f59e0b; }
        .loading { text-align: center; padding: 4rem; color: #D4A83C; }
        .loading-spinner { border: 4px solid rgba(212, 168, 60, 0.2); border-top: 4px solid #D4A83C; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error { background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; padding: 1rem; border-radius: 0.5rem; color: #ef4444; margin: 1rem 0; }
        .success { background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; padding: 1rem; border-radius: 0.5rem; color: #10b981; margin: 1rem 0; }
        .section-title { font-size: 2rem; font-weight: 700; margin-bottom: 1.5rem; color: #D4A83C; display: flex; align-items: center; gap: 0.75rem; }
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin: 2rem 0; }
        .stat-card { background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(212, 168, 60, 0.15); border-radius: 0.75rem; padding: 1.5rem; text-align: center; transition: all 0.3s; }
        .stat-card:hover { background: rgba(212, 168, 60, 0.05); transform: translateY(-3px); border-color: #D4A83C; }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap; border-bottom: 2px solid rgba(212, 168, 60, 0.2); padding-bottom: 0.5rem; }
        .tab { padding: 0.75rem 1.5rem; border-radius: 0.5rem 0.5rem 0 0; border: none; background: transparent; color: #9ca3af; cursor: pointer; font-weight: 600; transition: all 0.3s; border-bottom: 3px solid transparent; }
        .tab.active { background: rgba(212, 168, 60, 0.1); color: #D4A83C; border-bottom-color: #D4A83C; }
        .tab:hover:not(.active) { background: rgba(255, 255, 255, 0.05); color: #D4A83C; }
        .timeline { position: relative; padding-left: 2.5rem; margin: 2rem 0; }
        .timeline-item { margin-bottom: 2.5rem; position: relative; }
        .timeline-item::before { content: attr(data-icon); position: absolute; left: -2.5rem; top: 0; width: 2.5rem; height: 2.5rem; background: #D4A83C; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; border: 3px solid #0a1f1a; }
        .timeline-content { background: rgba(255, 255, 255, 0.03); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid rgba(212, 168, 60, 0.2); }
        .justificativa { background: rgba(255, 255, 255, 0.03); padding: 1.5rem; border-left: 4px solid #D4A83C; border-radius: 0.5rem; margin: 1rem 0; line-height: 1.8; }
        .recomendacao { background: linear-gradient(135deg, rgba(212, 168, 60, 0.2) 0%, rgba(27, 77, 62, 0.2) 100%); border: 2px solid #D4A83C; padding: 2.5rem; border-radius: 1rem; margin: 2rem 0; box-shadow: 0 10px 40px rgba(212, 168, 60, 0.2); }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // ============================================
        // CONFIGURA√á√ÉO DA API
        // ============================================
        
        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:8000'
            : 'https://ecofin-app-production.up.railway.app';
        
        const SENHA = "ecofin2025";

        // ============================================
        // COMPONENTE PRINCIPAL
        // ============================================

        function App() {
            const [auth, setAuth] = useState(false);
            const [view, setView] = useState('lista');
            const [cliente, setCliente] = useState(null);

            useEffect(() => {
                if (sessionStorage.getItem('ecofin_auth') === 'ok') {
                    setAuth(true);
                } else {
                    const s = prompt('üîê Senha de acesso ao painel:');
                    if (s === SENHA) {
                        sessionStorage.setItem('ecofin_auth', 'ok');
                        setAuth(true);
                    } else {
                        alert('‚ùå Senha incorreta!');
                        window.location.href = '/';
                    }
                }
            }, []);

            if (!auth) {
                return (
                    <div style={{display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100vh', flexDirection: 'column', gap: '1rem'}}>
                        <div style={{fontSize: '4rem'}}>üîí</div>
                        <p style={{color: '#D4A83C', fontSize: '1.25rem'}}>Verificando acesso...</p>
                    </div>
                );
            }

            if (view === 'lista') {
                return <Lista onSelect={(c) => { setCliente(c); setView('analise'); }} />;
            }

            return <Analise cliente={cliente} onVoltar={() => setView('lista')} />;
        }

        // ============================================
        // COMPONENTE: LISTA DE CLIENTES
        // ============================================

        function Lista({ onSelect }) {
            const [clientes, setClientes] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [busca, setBusca] = useState('');

            useEffect(() => {
                carregarClientes();
            }, []);

            const carregarClientes = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    
                    const response = await fetch(`${API_URL}/api/clientes`);
                    const data = await response.json();
                    
                    if (data.sucesso) {
                        setClientes(data.clientes);
                    } else {
                        throw new Error('Erro ao carregar clientes');
                    }
                } catch (err) {
                    console.error('Erro:', err);
                    setError('Erro ao carregar clientes. Tentando fallback...');
                    
                    // Fallback: buscar do localStorage
                    const local = JSON.parse(localStorage.getItem('ecofin_clientes') || '[]');
                    setClientes(local);
                } finally {
                    setLoading(false);
                }
            };

            const handleDelete = async (id, nome) => {
                if (!confirm(`‚ö†Ô∏è Tem certeza que deseja excluir ${nome}?`)) return;
                
                try {
                    await fetch(`${API_URL}/api/cliente/${id}`, { method: 'DELETE' });
                    await carregarClientes();
                    alert('‚úÖ Cliente exclu√≠do com sucesso!');
                } catch (err) {
                    console.error('Erro ao excluir:', err);
                    alert('Erro ao excluir cliente');
                }
            };

            const clientesFiltrados = clientes.filter(c => 
                c.nome?.toLowerCase().includes(busca.toLowerCase()) ||
                c.banco?.toLowerCase().includes(busca.toLowerCase())
            );

            if (loading) {
                return (
                    <div className="loading">
                        <div className="loading-spinner"></div>
                        <p>Carregando clientes...</p>
                    </div>
                );
            }

            return (
                <div className="container" style={{paddingTop: '2rem'}}>
                    <div style={{marginBottom: '2rem'}}>
                        <h1 className="section-title">
                            üîë Clientes EcoFin
                        </h1>
                        <p style={{color: '#9ca3af', marginBottom: '1.5rem'}}>
                            Clique em um cliente para gerar an√°lise completa via API Python
                        </p>
                        
                        {error && <div className="error">{error}</div>}
                        
                        <input
                            type="text"
                            placeholder="üîç Buscar por nome ou banco..."
                            value={busca}
                            onChange={(e) => setBusca(e.target.value)}
                            style={{
                                width: '100%',
                                maxWidth: '500px',
                                padding: '1rem',
                                borderRadius: '0.5rem',
                                border: '1px solid rgba(212, 168, 60, 0.3)',
                                background: 'rgba(255, 255, 255, 0.08)',
                                color: 'white',
                                marginBottom: '1rem'
                            }}
                        />
                    </div>

                    {clientesFiltrados.length === 0 ? (
                        <div className="glass" style={{textAlign: 'center', padding: '4rem'}}>
                            <div style={{fontSize: '5rem', marginBottom: '1rem'}}>üì≠</div>
                            <h2 style={{color: '#D4A83C', marginBottom: '0.5rem'}}>
                                {busca ? 'Nenhum cliente encontrado' : 'Nenhum cliente cadastrado'}
                            </h2>
                            <p style={{color: '#9ca3af'}}>
                                {busca ? 'Tente outro termo de busca' : 'Clientes aparecer√£o aqui quando fizerem cadastro'}
                            </p>
                        </div>
                    ) : (
                        <div style={{display: 'grid', gap: '1rem'}}>
                            {clientesFiltrados.map(c => (
                                <div key={c.id} className="glass" style={{
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center',
                                    transition: 'all 0.3s',
                                    cursor: 'pointer'
                                }}
                                onClick={() => onSelect(c)}
                                onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(212, 168, 60, 0.1)'}
                                onMouseLeave={(e) => e.currentTarget.style.background = 'rgba(212, 168, 60, 0.05)'}>
                                    <div style={{flex: 1}}>
                                        <h3 style={{fontSize: '1.25rem', fontWeight: '700', color: '#D4A83C', marginBottom: '0.5rem'}}>
                                            {c.nome}
                                        </h3>
                                        <p style={{color: '#9ca3af', fontSize: '0.875rem', marginBottom: '1rem'}}>
                                            üì± {c.whatsapp} ‚Ä¢ üè¶ {c.banco}
                                        </p>
                                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '1rem', fontSize: '0.875rem'}}>
                                            <div>
                                                <p style={{color: '#6b7280', fontSize: '0.75rem'}}>Saldo Devedor</p>
                                                <p style={{fontWeight: '600', color: '#ef4444'}}>
                                                    R$ {c.financiamento?.saldo_devedor?.toLocaleString('pt-BR') || 'N/A'}
                                                </p>
                                            </div>
                                            <div>
                                                <p style={{color: '#6b7280', fontSize: '0.75rem'}}>FGTS</p>
                                                <p style={{fontWeight: '600', color: '#10b981'}}>
                                                    R$ {(c.recursos?.valor_fgts || 0).toLocaleString('pt-BR')}
                                                </p>
                                            </div>
                                            <div>
                                                <p style={{color: '#6b7280', fontSize: '0.75rem'}}>Capacidade Extra</p>
                                                <p style={{fontWeight: '600', color: '#3b82f6'}}>
                                                    R$ {(c.recursos?.capacidade_extra || 0).toLocaleString('pt-BR')}/m√™s
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); handleDelete(c.id, c.nome); }} 
                                        className="btn-danger">
                                        üóëÔ∏è Excluir
                                    </button>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // ============================================
        // COMPONENTE: AN√ÅLISE DO CLIENTE
        // ============================================

        function Analise({ cliente, onVoltar }) {
            const [analise, setAnalise] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [tab, setTab] = useState('visao-geral');

            useEffect(() => {
                carregarAnalise();
            }, [cliente]);

            const carregarAnalise = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    
                    const response = await fetch(`${API_URL}/api/analise/${cliente.id}`);
                    const data = await response.json();
                    
                    if (data.sucesso) {
                        setAnalise(data);
                    } else {
                        throw new Error('Erro ao carregar an√°lise');
                    }
                } catch (err) {
                    console.error('Erro:', err);
                    setError('Erro ao carregar an√°lise da API. Verifique se o backend est√° rodando.');
                } finally {
                    setLoading(false);
                }
            };

            if (loading) {
                return (
                    <div className="loading">
                        <div className="loading-spinner"></div>
                        <p>Gerando an√°lise completa...</p>
                        <p style={{fontSize: '0.875rem', color: '#9ca3af', marginTop: '0.5rem'}}>
                            Otimizando 150+ cen√°rios via API Python
                        </p>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="container">
                        <div className="error">
                            <h3 style={{marginBottom: '0.5rem'}}>‚ùå Erro ao Carregar An√°lise</h3>
                            <p>{error}</p>
                            <p style={{marginTop: '1rem', fontSize: '0.875rem'}}>
                                Verifique se o backend est√° rodando em {API_URL}
                            </p>
                        </div>
                        <button onClick={onVoltar} className="btn-primary">‚Üê Voltar</button>
                    </div>
                );
            }

            if (!analise) return null;

            const { cenario_original, estrategia_otimizada, justificativa, plano_acao } = analise;
            const fmt = (v) => v ? `R$ ${parseFloat(v).toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : 'N/A';

            return (
                <div className="container">
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
                        <div>
                            <h1 style={{fontSize: '2.5rem', fontWeight: '700', color: '#D4A83C', marginBottom: '0.5rem'}}>
                                {cliente.nome}
                            </h1>
                            <p style={{color: '#9ca3af', fontSize: '1rem'}}>
                                An√°lise via API Python ‚Ä¢ Motor EcoFin v3
                            </p>
                        </div>
                        <button onClick={onVoltar} className="btn-primary">‚Üê Voltar</button>
                    </div>

                    <div className="tabs">
                        {[
                            {id: 'visao-geral', label: 'üìä Vis√£o Geral'},
                            {id: 'justificativa', label: 'üìù An√°lise Detalhada'},
                            {id: 'plano-acao', label: 'üéØ Plano de A√ß√£o'}
                        ].map(t => (
                            <button key={t.id} onClick={() => setTab(t.id)} className={`tab ${tab === t.id ? 'active' : ''}`}>
                                {t.label}
                            </button>
                        ))}
                    </div>

                    {tab === 'visao-geral' && (
                        <div>
                            <div className="recomendacao">
                                <div style={{display: 'flex', alignItems: 'center', gap: '1.5rem', marginBottom: '2rem'}}>
                                    <div style={{fontSize: '5rem'}}>üéØ</div>
                                    <div style={{flex: 1}}>
                                        <h2 style={{fontSize: '2.5rem', fontWeight: '700', color: '#D4A83C', marginBottom: '0.5rem'}}>
                                            {justificativa?.titulo || 'Estrat√©gia Otimizada'}
                                        </h2>
                                        <p style={{fontSize: '1.125rem', color: '#10b981', fontWeight: '600'}}>
                                            Calculado pela API Python ‚Ä¢ 150+ cen√°rios testados
                                        </p>
                                    </div>
                                </div>

                                <div className="stats-row">
                                    <div className="stat-card" style={{background: 'rgba(16, 185, 129, 0.1)', border: '2px solid #10b981'}}>
                                        <div className="metric-value positive">{fmt(estrategia_otimizada?.economia)}</div>
                                        <div className="metric-label">Economia Total</div>
                                    </div>
                                    <div className="stat-card" style={{background: 'rgba(59, 130, 246, 0.1)', border: '2px solid #3b82f6'}}>
                                        <div className="metric-value" style={{color: '#3b82f6'}}>
                                            {estrategia_otimizada?.reducao_prazo || 0}
                                        </div>
                                        <div className="metric-label">Meses Economizados</div>
                                    </div>
                                    <div className="stat-card" style={{background: 'rgba(212, 168, 60, 0.1)', border: '2px solid #D4A83C'}}>
                                        <div className="metric-value" style={{color: '#D4A83C'}}>
                                            {estrategia_otimizada?.viabilidade || 0}%
                                        </div>
                                        <div className="metric-label">Viabilidade</div>
                                    </div>
                                    {estrategia_otimizada?.roi > 0 && (
                                        <div className="stat-card" style={{background: 'rgba(16, 185, 129, 0.1)', border: '2px solid #10b981'}}>
                                            <div className="metric-value positive">
                                                {(estrategia_otimizada.roi * 12 * 100).toFixed(1)}%
                                            </div>
                                            <div className="metric-label">ROI Anual (isento IR)</div>
                                        </div>
                                    )}
                                </div>

                                <div style={{background: 'rgba(255, 255, 255, 0.05)', padding: '1.5rem', borderRadius: '0.5rem', marginTop: '1.5rem'}}>
                                    <h4 style={{color: '#D4A83C', marginBottom: '1rem'}}>üìå Estrat√©gia Recomendada:</h4>
                                    <div style={{display: 'grid', gap: '0.75rem'}}>
                                        {estrategia_otimizada?.fgts_usado > 0 && (
                                            <p>üí∞ <strong>FGTS Inicial:</strong> {fmt(estrategia_otimizada.fgts_usado)}</p>
                                        )}
                                        <p>üìÖ <strong>Amortiza√ß√£o Mensal:</strong> {fmt(estrategia_otimizada?.amortizacao_mensal)}</p>
                                        <p>üéØ <strong>Novo Prazo:</strong> {estrategia_otimizada?.prazo_meses} meses ({(estrategia_otimizada?.prazo_meses / 12).toFixed(1)} anos)</p>
                                        <p>üí∞ <strong>Total a Pagar:</strong> {fmt(estrategia_otimizada?.total_pago)}</p>
                                    </div>
                                </div>
                            </div>

                            <h3 className="section-title">üìä Compara√ß√£o: Sem vs Com Otimiza√ß√£o</h3>
                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '1.5rem'}}>
                                <div className="card">
                                    <h4 style={{color: '#ef4444', marginBottom: '1rem'}}>‚ùå Sem Fazer Nada</h4>
                                    <p><strong>Total Pago:</strong> {fmt(cenario_original?.total_pago)}</p>
                                    <p><strong>Juros:</strong> <span className="negative">{fmt(cenario_original?.total_juros)}</span></p>
                                    <p><strong>Prazo:</strong> {cenario_original?.prazo_meses} meses</p>
                                </div>

                                <div className="card" style={{border: '2px solid #10b981', background: 'rgba(16, 185, 129, 0.05)'}}>
                                    <h4 style={{color: '#10b981', marginBottom: '1rem'}}>‚úÖ Com Estrat√©gia API</h4>
                                    <p><strong>Total Pago:</strong> {fmt(estrategia_otimizada?.total_pago)}</p>
                                    <p><strong>Juros:</strong> <span className="positive">{fmt(estrategia_otimizada?.total_juros)}</span></p>
                                    <p><strong>Prazo:</strong> {estrategia_otimizada?.prazo_meses} meses</p>
                                    <p className="positive"><strong>ECONOMIA: {fmt(estrategia_otimizada?.economia)}</strong></p>
                                </div>
                            </div>
                        </div>
                    )}

                    {tab === 'justificativa' && (
                        <div>
                            <h2 className="section-title">üìù An√°lise Profissional Detalhada</h2>
                            {justificativa && Object.entries(justificativa).map(([key, value]) => (
                                <div key={key} className="justificativa">
                                    <div dangerouslySetInnerHTML={{__html: value}}></div>
                                </div>
                            ))}
                        </div>
                    )}

                    {tab === 'plano-acao' && (
                        <div>
                            <h2 className="section-title">üéØ Plano de A√ß√£o Completo</h2>
                            <div className="timeline">
                                {plano_acao?.map((passo, idx) => (
                                    <div key={idx} className="timeline-item" data-icon={passo.titulo?.split(' ')[0] || 'üìç'}>
                                        <div className="timeline-content">
                                            <h3 style={{color: '#D4A83C', fontSize: '1.25rem', marginBottom: '0.5rem'}}>
                                                {passo.titulo}
                                            </h3>
                                            <p style={{color: '#9ca3af', fontSize: '0.875rem', marginBottom: '1rem'}}>
                                                {passo.prazo} ‚Ä¢ <span className={`badge badge-${passo.prioridade?.toLowerCase()}`}>
                                                    {passo.prioridade}
                                                </span>
                                            </p>
                                            <p style={{lineHeight: 1.7}}>{passo.descricao}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    <div className="success" style={{marginTop: '2rem'}}>
                        <strong>‚úÖ An√°lise gerada pela API Python EcoFin</strong><br/>
                        Motor validado 100% contra planilha ‚Ä¢ Otimiza√ß√£o matem√°tica autom√°tica
                    </div>
                </div>
            );
        }

        // ============================================
        // RENDER
        // ============================================

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>