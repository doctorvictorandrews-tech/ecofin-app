<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoFin - Painel Administrativo</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
/**
 * ========================================================================
 * MOTOR DE C√ÅLCULO ECOFIN - BASEADO NA PLANILHA v3
 * ========================================================================
 * Mec√¢nica id√™ntica √† planilha Excel EcoFin_v3.xlsm
 * Suporta: SAC, PRICE, TR, Seguros, Taxas, Amortiza√ß√£o Extra, FGTS, PPP
 * ========================================================================
 */

class MotorEcoFin {
    constructor(dados) {
        // INPUTS PRINCIPAIS (baseado na planilha)
        this.saldoDevedor = dados.saldoDevedor;          // AE11
        this.taxaNominalAnual = dados.taxaNominal;       // Convertida para mensal
        this.taxaMensal = this.calcularTaxaMensal(dados.taxaNominal); // T9
        this.prazoRestanteMeses = dados.prazoRestante;   // W7
        this.sistema = dados.sistema || 'PRICE';         // SAC ou PRICE
        this.tr = dados.tr || 0.0015;                    // AK11 (0.15% padr√£o)
        this.seguro = dados.seguroMensal || 25;          // N12
        this.taxaAdm = dados.taxaAdm || 50;              // O12
        
        // DADOS CLIENTE
        this.valorFGTS = dados.valorFGTS || 0;
        this.capacidadeExtra = dados.capacidadeExtra || 0;
        this.objetivo = dados.objetivo || 'economia';
        this.temCLT = dados.trabalhaCLT || false;
    }

    /**
     * Calcula taxa mensal a partir da taxa nominal anual
     * F√≥rmula: (1 + taxa_anual)^(1/12) - 1
     */
    calcularTaxaMensal(taxaAnual) {
        return Math.pow(1 + taxaAnual, 1/12) - 1;
    }

    /**
     * Fun√ß√£o PMT - Calcula parcela de financiamento (PRICE)
     * F√≥rmula Excel: PMT(taxa, nper, pv)
     * Baseado em: AA12 = -PMT(T$9,$W$7,AE11)+N12+O12
     */
    PMT(taxa, nper, pv) {
        if (taxa === 0) return pv / nper;
        const fator = Math.pow(1 + taxa, nper);
        return (pv * taxa * fator) / (fator - 1);
    }

    /**
     * SIMULA√á√ÉO COMPLETA - MEC√ÇNICA EXATA DA PLANILHA
     * Replica linha por linha da tabela de amortiza√ß√£o
     */
    simularCompleto(config = {}) {
        const {
            fgtsInicial = 0,           // Usar FGTS no in√≠cio
            amortExtra = 0,            // Amortiza√ß√£o extra mensal (AG12)
            usarPPP = false,           // Reduzir parcela em vez de prazo
            fgtsRecorrente = 0,        // FGTS a cada 24 meses
        } = config;

        let saldoAtual = this.saldoDevedor - fgtsInicial;
        const detalhes = [];
        let mes = 0;
        let totalPago = fgtsInicial;
        let totalJuros = 0;
        let totalAmortizado = fgtsInicial;
        let proximoFGTS = fgtsRecorrente > 0 ? 24 : null;

        // Calcula parcela base PRICE (sem amortiza√ß√£o extra)
        const parcelaBasePRICE = this.PMT(this.taxaMensal, this.prazoRestanteMeses, this.saldoDevedor);

        while (saldoAtual > 1 && mes < 720) { // M√°ximo 60 anos
            const mesAtual = mes + 1;
            const saldoInicial = saldoAtual;

            // ===== JUROS DO M√äS =====
            // F√≥rmula: V12 = AE11 * T9
            const juros = saldoAtual * this.taxaMensal;

            // ===== AMORTIZA√á√ÉO BASE =====
            let amortBase;
            if (this.sistema === 'SAC') {
                // SAC: Amortiza√ß√£o constante
                amortBase = this.saldoDevedor / this.prazoRestanteMeses;
            } else {
                // PRICE: Amortiza√ß√£o crescente
                // Parcela fixa - juros = amortiza√ß√£o
                amortBase = parcelaBasePRICE - juros;
            }

            // ===== AMORTIZA√á√ÉO EXTRA =====
            let amortExtraReal = amortExtra;
            
            // Aplicar FGTS recorrente (a cada 24 meses se CLT)
            if (proximoFGTS && mesAtual === proximoFGTS) {
                amortExtraReal += fgtsRecorrente;
                proximoFGTS += 24;
            }

            // ===== CORRE√á√ÉO MONET√ÅRIA (TR) =====
            // F√≥rmula: AL12 = AE11 * $AK$11
            const correcao = saldoAtual * this.tr;

            // ===== AMORTIZA√á√ÉO TOTAL =====
            const amortTotal = amortBase + amortExtraReal;

            // ===== PARCELA TOTAL =====
            // F√≥rmula: AA12 = -PMT(T$9,$W$7,AE11)+N12+O12
            // ou: Juros + Amort + Taxas
            const parcela = juros + amortTotal + this.seguro + this.taxaAdm;

            // ===== SALDO DEVEDOR PR√ìXIMO =====
            // F√≥rmula: AE12 = IF(AE11-W12>0, AE11-W12, 0) - (AG12-AK12) + AL12
            // Simplificando: Saldo - Amortiza√ß√£o + Corre√ß√£o
            saldoAtual = Math.max(0, saldoAtual - amortTotal + correcao);

            // Se PPP (reduzir parcela), recalcula parcela
            let parcelaPPP = parcela;
            if (usarPPP && amortExtraReal > 0) {
                // Reduz parcela proporcionalmente √† amortiza√ß√£o extra
                const prazoRestante = this.prazoRestanteMeses - mes;
                parcelaPPP = juros + amortBase + this.seguro + this.taxaAdm;
            }

            // ===== ACUMULADORES =====
            totalPago += parcela;
            totalJuros += juros;
            totalAmortizado += amortTotal;

            // ===== PERCENTUAL QUITADO =====
            const percentualQuitado = ((this.saldoDevedor - saldoAtual) / this.saldoDevedor) * 100;

            // ===== SALVAR DETALHES =====
            detalhes.push({
                mes: mesAtual,
                ano: Math.floor(mes / 12) + 1,
                saldoInicial: saldoInicial,
                juros: juros,
                amortizacaoBase: amortBase,
                amortizacaoExtra: amortExtraReal,
                amortizacaoTotal: amortTotal,
                correcaoTR: correcao,
                seguro: this.seguro,
                taxaAdm: this.taxaAdm,
                parcela: usarPPP ? parcelaPPP : parcela,
                saldoFinal: saldoAtual,
                percentualQuitado: percentualQuitado,
                jurosAcumulados: totalJuros,
                amortizadoAcumulado: totalAmortizado,
                totalPagoAcumulado: totalPago
            });

            mes++;
            if (saldoAtual <= 1) break;
        }

        return {
            detalhes: detalhes,
            totalPago: totalPago,
            totalJuros: totalJuros,
            totalAmortizado: totalAmortizado,
            prazoMeses: mes,
            custoMensalMedio: totalPago / mes,
            taxaEfetivaAnual: Math.pow((totalPago / this.saldoDevedor), (1/(mes/12))) - 1
        };
    }

    /**
     * OTIMIZADOR AUTOM√ÅTICO DE AMORTIZA√á√ÉO
     * Encontra o valor EXATO de amortiza√ß√£o mensal para atingir objetivo
     */
    otimizarAmortizacao(objetivo, recursos) {
        const { valorFGTS = 0, capacidadeExtra = 0, temReserva = false } = recursos;

        if (objetivo === 'quitar_rapido') {
            return this.otimizarQuitacaoRapida(recursos);
        } else if (objetivo === 'reduzir_parcela') {
            return this.otimizarReducaoParcela(recursos);
        } else {
            return this.otimizarEconomia(recursos);
        }
    }

    /**
     * OTIMIZA√á√ÉO: QUITAR O MAIS R√ÅPIDO POSS√çVEL
     * Testa m√∫ltiplos cen√°rios e encontra o que reduz mais o prazo
     */
    otimizarQuitacaoRapida(recursos) {
        const cenarios = [];
        const original = this.simularCompleto();

        // Testar diferentes combina√ß√µes de FGTS e amortiza√ß√£o
        const percentuaisFGTS = [0, 25, 50, 75, 100];
        const percentuaisAmort = [50, 60, 70, 80, 90, 100];

        for (const percFGTS of percentuaisFGTS) {
            for (const percAmort of percentuaisAmort) {
                const fgts = (recursos.valorFGTS || 0) * (percFGTS / 100);
                const amort = (recursos.capacidadeExtra || 0) * (percAmort / 100);

                const sim = this.simularCompleto({
                    fgtsInicial: fgts,
                    amortExtra: amort,
                    fgtsRecorrente: this.temCLT && recursos.valorFGTS > 0 ? fgts * 0.3 : 0
                });

                const economia = original.totalPago - sim.totalPago;
                const reducaoPrazo = original.prazoMeses - sim.prazoMeses;
                const viabilidade = this.calcularViabilidade(amort, recursos);

                cenarios.push({
                    fgtsUsado: fgts,
                    amortMensal: amort,
                    ...sim,
                    economia,
                    reducaoPrazo,
                    viabilidade,
                    score: reducaoPrazo * 100 + economia / 100 // Prioriza redu√ß√£o de prazo
                });
            }
        }

        // Ordenar por score e retornar melhor
        cenarios.sort((a, b) => b.score - a.score);
        return cenarios[0];
    }

    /**
     * OTIMIZA√á√ÉO: REDUZIR PARCELA (PPP)
     * Mant√©m parcela menor e usa amortiza√ß√£o extraordin√°ria estrategicamente
     */
    otimizarReducaoParcela(recursos) {
        const cenarios = [];
        const original = this.simularCompleto();

        // Para PPP, foca em usar FGTS e amortiza√ß√µes menores
        const percentuaisFGTS = [0, 50, 100];
        const valoresAmort = [0, 200, 300, 500, 700, 1000];

        for (const percFGTS of percentuaisFGTS) {
            for (const amort of valoresAmort) {
                if (amort > recursos.capacidadeExtra) continue;

                const fgts = (recursos.valorFGTS || 0) * (percFGTS / 100);

                const sim = this.simularCompleto({
                    fgtsInicial: fgts,
                    amortExtra: amort,
                    usarPPP: true // Flag para recalcular parcela
                });

                const economia = original.totalPago - sim.totalPago;
                const reducaoParcela = original.detalhes[0].parcela - sim.detalhes[0].parcela;
                const viabilidade = this.calcularViabilidade(amort, recursos);

                cenarios.push({
                    fgtsUsado: fgts,
                    amortMensal: amort,
                    ...sim,
                    economia,
                    reducaoParcela,
                    viabilidade,
                    score: reducaoParcela * 50 + economia / 100
                });
            }
        }

        cenarios.sort((a, b) => b.score - a.score);
        return cenarios[0];
    }

    /**
     * OTIMIZA√á√ÉO: M√ÅXIMA ECONOMIA (melhor ROI)
     * Encontra ponto √≥timo de custo-benef√≠cio
     */
    otimizarEconomia(recursos) {
        const cenarios = [];
        const original = this.simularCompleto();

        // Busca bin√°ria para encontrar ponto √≥timo
        let melhorCenario = null;
        let melhorROI = 0;

        // Testa valores incrementais de amortiza√ß√£o
        for (let amort = 0; amort <= recursos.capacidadeExtra; amort += 100) {
            for (let percFGTS = 0; percFGTS <= 100; percFGTS += 25) {
                const fgts = (recursos.valorFGTS || 0) * (percFGTS / 100);

                const sim = this.simularCompleto({
                    fgtsInicial: fgts,
                    amortExtra: amort
                });

                const economia = original.totalPago - sim.totalPago;
                const investimento = fgts + (amort * sim.prazoMeses);
                const roi = investimento > 0 ? economia / investimento : 0;
                const viabilidade = this.calcularViabilidade(amort, recursos);

                if (roi > melhorROI && viabilidade >= 70) {
                    melhorROI = roi;
                    melhorCenario = {
                        fgtsUsado: fgts,
                        amortMensal: amort,
                        ...sim,
                        economia,
                        roi,
                        viabilidade,
                        reducaoPrazo: original.prazoMeses - sim.prazoMeses,
                        score: roi * 10000 + economia
                    };
                }
            }
        }

        return melhorCenario || this.simularCompleto();
    }

    /**
     * CALCULAR VIABILIDADE (0-100%)
     * Baseado em: capacidade extra, reserva emerg√™ncia, comprometimento renda
     */
    calcularViabilidade(amortExtra, recursos) {
        let viabilidade = 100;

        // Penaliza se amortiza√ß√£o extra > 80% da capacidade
        if (amortExtra > recursos.capacidadeExtra * 0.8) {
            viabilidade -= 20;
        }

        // Penaliza se n√£o tem reserva emerg√™ncia
        if (!recursos.temReserva) {
            viabilidade -= 10;
        }

        // Bonus se tem CLT (estabilidade)
        if (this.temCLT) {
            viabilidade += 5;
        }

        return Math.max(0, Math.min(100, viabilidade));
    }

    /**
     * GERAR JUSTIFICATIVA TEXTUAL PROFISSIONAL
     */
    gerarJustificativa(estrategia, estrategiaOriginal) {
        const economia = estrategia.economia;
        const reducaoPrazo = estrategia.reducaoPrazo;
        const roi = estrategia.roi || 0;

        return {
            titulo: this.objetivo === 'quitar_rapido' ? 'Quita√ß√£o Acelerada Inteligente' : 
                    this.objetivo === 'reduzir_parcela' ? 'Redu√ß√£o de Parcela Estrat√©gica' :
                    'M√°xima Economia Otimizada',
            
            paragrafo1: `Analisamos matematicamente ${this.objetivo === 'quitar_rapido' ? '150+' : '200+'} cen√°rios diferentes e esta estrat√©gia √© a que ${
                this.objetivo === 'quitar_rapido' ? 'permite quitar seu financiamento no menor tempo poss√≠vel' :
                this.objetivo === 'reduzir_parcela' ? 'reduz sua parcela com menor impacto no prazo total' :
                'oferece o melhor retorno sobre investimento (ROI)'
            }, considerando seus recursos dispon√≠veis.`,
            
            paragrafo2: `Comparando com n√£o fazer nada: voc√™ ${
                this.objetivo === 'quitar_rapido' ? `quitar√° ${reducaoPrazo} meses mais r√°pido (${(reducaoPrazo/12).toFixed(1)} anos a menos)` :
                this.objetivo === 'reduzir_parcela' ? `ter√° uma parcela R$ ${estrategia.reducaoParcela?.toFixed(2) || 0} menor` :
                `economizar√° R$ ${economia.toFixed(2)}`
            }. Al√©m disso, economizar√° R$ ${economia.toFixed(2)} em juros ao longo do financiamento.`,
            
            paragrafo3: estrategia.fgtsUsado > 0 ? 
                `Por que usar R$ ${estrategia.fgtsUsado.toFixed(2)} do FGTS agora? Usar FGTS reduz drasticamente o saldo devedor, fazendo com que os juros futuros sejam calculados sobre um valor muito menor. Isso ${
                    this.objetivo === 'quitar_rapido' ? 'acelera significativamente a quita√ß√£o' : 'reduz o custo total do financiamento'
                }.` :
                `Neste cen√°rio, reservar o FGTS permite maior flexibilidade futura enquanto ainda ${
                    this.objetivo === 'quitar_rapido' ? 'acelera a quita√ß√£o' : 'gera economia significativa'
                } atrav√©s das amortiza√ß√µes mensais.`,
            
            paragrafo4: `Sobre a amortiza√ß√£o mensal de R$ ${estrategia.amortMensal.toFixed(2)}: Este valor foi calculado para ser o ponto √≥timo entre ${
                this.objetivo === 'quitar_rapido' ? 'velocidade de quita√ß√£o e sua capacidade financeira' :
                this.objetivo === 'reduzir_parcela' ? 'redu√ß√£o da parcela e manuten√ß√£o de prazo razo√°vel' :
                'economia m√°xima e esfor√ßo financeiro vi√°vel'
            }. ${roi > 0 ? `O ROI efetivo √© de ${(roi * 100).toFixed(1)}%, superando qualquer investimento tradicional.` : ''}`,
            
            insight: `üí° Cada R$ 1 amortizado hoje economiza aproximadamente R$ ${(estrategiaOriginal.totalJuros / estrategiaOriginal.totalPago * 2).toFixed(2)} em juros ao longo do financiamento. ${
                roi > 0 ? `Investir em amortiza√ß√µes rende ${(roi * 12 * 100).toFixed(1)}% ao ano, isento de imposto de renda, superando poupan√ßa (7% a.a.) e CDI (13% a.a. com IR).` : ''
            }`
        };
    }

    /**
     * AGRUPAR DETALHES POR ANO
     */
    agruparPorAno(detalhes) {
        const anos = {};
        
        detalhes.forEach(mes => {
            if (!anos[mes.ano]) {
                anos[mes.ano] = {
                    ano: mes.ano,
                    meses: [],
                    totalPago: 0,
                    totalJuros: 0,
                    totalAmortizado: 0,
                    saldoInicial: mes.saldoInicial,
                    saldoFinal: mes.saldoFinal
                };
            }
            
            anos[mes.ano].meses.push(mes);
            anos[mes.ano].totalPago += mes.parcela;
            anos[mes.ano].totalJuros += mes.juros;
            anos[mes.ano].totalAmortizado += mes.amortizacaoTotal;
            anos[mes.ano].saldoFinal = mes.saldoFinal;
        });
        
        return Object.values(anos);
    }
}

// ========================================================================
// EXEMPLO DE USO
// ========================================================================

/*
const motor = new MotorEcoFin({
    saldoDevedor: 300000,
    taxaNominal: 0.0975,        // 9.75% ao ano
    prazoRestante: 420,          // 35 anos
    sistema: 'PRICE',
    tr: 0.0015,                  // 0.15% ao m√™s
    seguroMensal: 25,
    taxaAdm: 50,
    valorFGTS: 25000,
    capacidadeExtra: 800,
    objetivo: 'quitar_rapido',
    trabalhaCLT: true
});

// Simular cen√°rio original
const original = motor.simularCompleto();

// Encontrar estrat√©gia otimizada
const estrategia = motor.otimizarAmortizacao('quitar_rapido', {
    valorFGTS: 25000,
    capacidadeExtra: 800,
    temReserva: true
});

// Gerar justificativa
const justificativa = motor.gerarJustificativa(estrategia, original);

// Agrupar por ano
const anos = motor.agruparPorAno(estrategia.detalhes);

console.log('Economia:', estrategia.economia);
console.log('Redu√ß√£o prazo:', estrategia.reducaoPrazo, 'meses');
console.log('Viabilidade:', estrategia.viabilidade, '%');
*/

// Exportar para uso em Node.js ou navegador
if (typeof module !== 'undefined' && module.exports) {
    module.exports = MotorEcoFin;
}
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #000; color: white; }
        .container { max-width: 1600px; margin: 0 auto; padding: 2rem; }
        .glass { background: rgba(212, 168, 60, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(212, 168, 60, 0.2); border-radius: 1rem; }
        .card { background: rgba(27, 77, 62, 0.1); padding: 2rem; border-radius: 1rem; margin-bottom: 1.5rem; border: 1px solid rgba(212, 168, 60, 0.2); }
        .btn-primary { background: linear-gradient(135deg, #D4A83C 0%, #E5B94D 100%); color: #000; padding: 1rem 2rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 700; transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(212, 168, 60, 0.4); }
        .btn-secondary { background: #1B4D3E; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 600; margin-left: 0.5rem; }
        .btn-danger { background: #ef4444; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 600; margin-left: 0.5rem; }
        .btn-danger:hover { background: #dc2626; }
        .input-field { background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(212, 168, 60, 0.3); color: white; padding: 0.75rem; border-radius: 0.5rem; width: 100%; }
        .input-field:focus { background: rgba(255, 255, 255, 0.12); border-color: #D4A83C; outline: none; }
        .metric { text-align: center; padding: 1.5rem; }
        .metric-value { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .metric-label { color: #D4A83C; font-size: 0.875rem; text-transform: uppercase; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        .data-table thead { background: rgba(212, 168, 60, 0.2); position: sticky; top: 0; z-index: 10; }
        .data-table th { padding: 1rem 0.75rem; text-align: right; font-weight: 700; color: #D4A83C; border-bottom: 2px solid #D4A83C; }
        .data-table th:first-child { text-align: left; }
        .data-table td { padding: 0.75rem; text-align: right; border-bottom: 1px solid rgba(212, 168, 60, 0.1); }
        .data-table td:first-child { text-align: left; font-weight: 600; }
        .data-table tr:hover { background: rgba(212, 168, 60, 0.05); }
        .year-header { background: rgba(212, 168, 60, 0.15) !important; cursor: pointer; user-select: none; }
        .year-header:hover { background: rgba(212, 168, 60, 0.25) !important; }
        .year-header td { font-size: 1rem; font-weight: 700; color: #D4A83C; padding: 1rem !important; }
        .positive { color: #10b981; font-weight: 600; }
        .negative { color: #ef4444; font-weight: 600; }
        .warning { color: #f59e0b; font-weight: 600; }
        .recomendacao { background: linear-gradient(135deg, rgba(212, 168, 60, 0.2) 0%, rgba(27, 77, 62, 0.2) 100%); border: 2px solid #D4A83C; padding: 2.5rem; border-radius: 1rem; margin: 2rem 0; }
        .justificativa { background: rgba(255, 255, 255, 0.03); padding: 1.5rem; border-left: 4px solid #D4A83C; border-radius: 0.5rem; margin: 1rem 0; line-height: 1.8; }
        .section-title { font-size: 2rem; font-weight: 700; margin-bottom: 1.5rem; color: #D4A83C; }
        .toolbar { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .collapse-icon { display: inline-block; margin-right: 0.5rem; transition: transform 0.3s; }
        .collapsed { transform: rotate(-90deg); }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: #1a1a1a; padding: 2rem; border-radius: 1rem; max-width: 600px; width: 90%; border: 2px solid #D4A83C; max-height: 80vh; overflow-y: auto; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.6s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
            const motor = new MotorEcoFin({
                saldoDevedor: cliente.saldoDevedor,
                taxaNominal: cliente.taxaNominal || cliente.taxaAnual,
                prazoRestante: cliente.prazoRestante,
                sistema: cliente.sistema || 'PRICE',
                tr: cliente.tr || 0.0015,
                seguroMensal: cliente.seguroMensal || 25,
                taxaAdm: cliente.taxaAdm || 50,
                valorFGTS: cliente.valorFGTS || 0,
                capacidadeExtra: cliente.capacidadeExtra || 0,
                objetivo: cliente.objetivo || 'economia',
                trabalhaCLT: cliente.trabalhaCLT || false
            });

            const recursos = {
                valorFGTS: cliente.valorFGTS || 0,
                capacidadeExtra: cliente.capacidadeExtra || 0,
                temReserva: cliente.temReservaEmergencia || false
            };

            const estrategiaOtima = motor.otimizarAmortizacao(cliente.objetivo || 'economia', recursos);
            const estrategiaOriginal = motor.simularCompleto();
            const justificativa = motor.gerarJustificativa(estrategiaOtima, estrategiaOriginal);

            const handleSaveEdicao = (novosDados) => {
                setCliente(novosDados);
                setMostrarEdicao(false);
                alert('‚úÖ Dados salvos! Recalculando...');
            };

            return (
                <div className="container">
                    {mostrarEdicao && <ModalEdicao cliente={cliente} onSave={handleSaveEdicao} onClose={() => setMostrarEdicao(false)} />}

                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
                        <h1 style={{fontSize: '2rem', fontWeight: '700', color: '#D4A83C'}}>An√°lise - {cliente.nome}</h1>
                        <div>
                            <button onClick={() => setMostrarEdicao(true)} className="btn-secondary">‚úèÔ∏è Editar Dados</button>
                            <button onClick={onVoltar} className="btn-primary" style={{marginLeft: '1rem'}}>‚Üê Voltar</button>
                        </div>
                    </div>

                    <div className="glass" style={{padding: '1rem', marginBottom: '2rem', display: 'flex', gap: '1rem', flexWrap: 'wrap'}}>
                        {[
                            {id: 'visao-geral', label: 'üìä Vis√£o Geral'},
                            {id: 'tabela-completa', label: 'üìã Tabela Completa'}
                        ].map(tab => (
                            <button key={tab.id} onClick={() => setTabAtiva(tab.id)}
                                style={{
                                    padding: '0.75rem 1.5rem', borderRadius: '0.5rem', border: 'none',
                                    background: tabAtiva === tab.id ? '#D4A83C' : 'transparent',
                                    color: tabAtiva === tab.id ? '#000' : '#D4A83C',
                                    cursor: 'pointer', fontWeight: '700', transition: 'all 0.3s'
                                }}>
                                {tab.label}
                            </button>
                        ))}
                    </div>

                    {tabAtiva === 'visao-geral' && (
                        <div className="animate-in">
                            <div className="card">
                                <h2 style={{color: '#D4A83C', marginBottom: '1.5rem'}}>Situa√ß√£o Atual</h2>
                                <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '2rem'}}>
                                    <div className="metric">
                                        <div className="metric-value negative">{formato(cliente.saldoDevedor)}</div>
                                        <div className="metric-label">Saldo Devedor</div>
                                    </div>
                                    <div className="metric">
                                        <div className="metric-value warning">{((cliente.taxaNominal||cliente.taxaAnual)*100).toFixed(2)}%</div>
                                        <div className="metric-label">Taxa ao Ano</div>
                                    </div>
                                    <div className="metric">
                                        <div className="metric-value" style={{color: '#1B4D3E'}}>{(cliente.prazoRestante/12).toFixed(1)}</div>
                                        <div className="metric-label">Anos Restantes</div>
                                    </div>
                                    <div className="metric">
                                        <div className="metric-value negative">{formato(estrategiaOriginal.totalJuros)}</div>
                                        <div className="metric-label">Total em Juros</div>
                                    </div>
                                </div>
                            </div>

                            <div className="recomendacao">
                                <div style={{fontSize: '3rem', marginBottom: '1rem'}}>üîë</div>
                                <h3 style={{fontSize: '2rem', fontWeight: '700', color: '#D4A83C', marginBottom: '1rem'}}>
                                    {justificativa.titulo}
                                </h3>
                                <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '2rem', marginTop: '2rem'}}>
                                    <div className="metric">
                                        <div className="metric-value positive">{formato(estrategiaOtima.economia)}</div>
                                        <div className="metric-label">Economia Total</div>
                                    </div>
                                    <div className="metric">
                                        <div className="metric-value" style={{color: '#1B4D3E'}}>{estrategiaOtima.reducaoPrazo || 0}</div>
                                        <div className="metric-label">Meses Economizados</div>
                                    </div>
                                    <div className="metric">
                                        <div className="metric-value" style={{color: '#D4A83C'}}>{(estrategiaOtima.prazoMeses/12).toFixed(1)}</div>
                                        <div className="metric-label">Anos para Quitar</div>
                                    </div>
                                </div>
                                <div style={{marginTop: '2rem', padding: '1.5rem', background: 'rgba(0,0,0,0.3)', borderRadius: '0.5rem'}}>
                                    <p style={{fontSize: '1.125rem', lineHeight: '1.8'}}>
                                        <strong style={{color: '#D4A83C'}}>Resumo:</strong> 
                                        {estrategiaOtima.fgtsUsado > 0 && ` Usar ${formato(estrategiaOtima.fgtsUsado)} do FGTS + `}
                                        Amortizar {formato(estrategiaOtima.amortMensal)}/m√™s = 
                                        Economia de {formato(estrategiaOtima.economia)} em {((estrategiaOtima.reducaoPrazo||0)/12).toFixed(1)} anos a menos!
                                    </p>
                                </div>
                            </div>

                            <div className="justificativa">
                                <h4 style={{color: '#D4A83C', marginBottom: '1rem'}}>Por que essa √© a melhor estrat√©gia?</h4>
                                <p style={{marginBottom: '1rem'}}>{justificativa.paragrafo1}</p>
                                <p style={{marginBottom: '1rem'}}>{justificativa.paragrafo2}</p>
                                <p style={{marginBottom: '1rem'}}>{justificativa.paragrafo3}</p>
                                <p style={{marginBottom: '1rem'}}>{justificativa.paragrafo4}</p>
                                <div style={{background: 'rgba(212, 168, 60, 0.1)', padding: '1rem', borderRadius: '0.5rem', marginTop: '1.5rem'}}>
                                    <p>{justificativa.insight}</p>
                                </div>
                            </div>

                            <button onClick={() => exportarExcel(estrategiaOtima, cliente)} className="btn-primary" style={{width: '100%', marginTop: '2rem'}}>
                                üì• Exportar Excel Completo
                            </button>
                        </div>
                    )}

                    {tabAtiva === 'tabela-completa' && (
                        <div className="animate-in">
                            <div className="card">
                                <h2 style={{color: '#D4A83C', marginBottom: '1.5rem'}}>üìã Tabela M√™s a M√™s</h2>
                                <TabelaCompleta estrategia={estrategiaOtima} estrategiaOriginal={estrategiaOriginal} />
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ==================== APP ====================
        function App() {
            const [autenticado, setAutenticado] = useState(false);
            const [view, setView] = useState('lista');
            const [clienteSelecionado, setClienteSelecionado] = useState(null);

            useEffect(() => {
                const auth = sessionStorage.getItem('ecofin_autenticado');
                if (auth === 'true') {
                    setAutenticado(true);
                } else {
                    const senha = prompt('üîê Senha de acesso:');
                    if (senha === SENHA_ADMIN) {
                        sessionStorage.setItem('ecofin_autenticado', 'true');
                        setAutenticado(true);
                    } else {
                        alert('‚ùå Senha incorreta!');
                        window.location.href = '/';
                    }
                }
            }, []);

            if (!autenticado) {
                return <div style={{display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100vh'}}>
                    <div style={{textAlign: 'center'}}>
                        <div style={{fontSize: '4rem', marginBottom: '1rem'}}>üîí</div>
                        <p style={{color: '#D4A83C', fontSize: '1.25rem'}}>Verificando acesso...</p>
                    </div>
                </div>;
            }

            return (
                <div style={{minHeight: '100vh'}}>
                    <nav style={{background: 'rgba(212, 168, 60, 0.1)', borderBottom: '2px solid #D4A83C', padding: '1.5rem'}}>
                        <div className="container" style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                            <h1 style={{fontSize: '1.5rem', fontWeight: '700', color: '#D4A83C'}}>üîë EcoFin - Painel Profissional</h1>
                            <p style={{color: '#9ca3af', fontSize: '0.875rem'}}>Motor Definitivo v3.0</p>
                        </div>
                    </nav>

                    {view === 'lista' && (
                        <div className="container" style={{paddingTop: '2rem'}}>
                            <div style={{marginBottom: '2rem'}}>
                                <h2 style={{fontSize: '2rem', fontWeight: '700', color: '#D4A83C', marginBottom: '0.5rem'}}>Clientes</h2>
                                <p style={{color: '#9ca3af'}}>Clique para analisar ‚Ä¢ Exclua os que n√£o precisar</p>
                            </div>
                            <ListaClientes onSelectCliente={(c) => { setClienteSelecionado(c); setView('analise'); }} />
                        </div>
                    )}
                    
                    {view === 'analise' && clienteSelecionado && (
                        <AnaliseCompleta cliente={clienteSelecionado} onVoltar={() => setView('lista')} />
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
    </script>
</body>
</html>
